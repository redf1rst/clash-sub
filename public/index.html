<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Clash Sub</title>
	<link rel="icon" type="image/png" href="https://github.com/redf1rst/clash-sub/blob/main/img/clash-sub.png?raw=true">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css" />
	<!-- è®¿é—®ä»¤ç‰Œæ£€æŸ¥ - åœ¨é¡µé¢åŠ è½½å‰æ‰§è¡Œ -->
	<script>
		(function () {
			// æ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®ä»¤ç‰ŒCookie (æ£€æŸ¥å‰ç«¯å¯è¯»çš„æ ‡è®°cookie)
			function hasTokenCookie() {
				return document.cookie.split(';').some(function (c) {
					return c.trim().startsWith('access_token_client=');
				});
			}

			// æ£€æŸ¥æ˜¯å¦æ˜¯ä»éªŒè¯é¡µé¢åˆšåˆšè·³è½¬è¿‡æ¥(å¸¦verifiedå‚æ•°)
			function isJustVerified() {
				var urlParams = new URLSearchParams(window.location.search);
				return urlParams.get('verified') === '1';
			}

			// å¦‚æœåˆšéªŒè¯æˆåŠŸ,æ¸…ç†URLå‚æ•°å¹¶è·³è¿‡cookieæ£€æŸ¥
			if (isJustVerified()) {
				// æ¸…ç†URLä¸­çš„verifiedå‚æ•°
				var url = new URL(window.location.href);
				url.searchParams.delete('verified');
				window.history.replaceState({}, document.title, url.pathname + url.search);
				return; // è·³è¿‡cookieæ£€æŸ¥,å…è®¸é¡µé¢åŠ è½½
			}

			// å¦‚æœæ²¡æœ‰ä»¤ç‰ŒCookieï¼Œé‡å®šå‘åˆ°éªŒè¯é¡µé¢
			if (!hasTokenCookie()) {
				var currentPath = window.location.pathname;
				var currentSearch = window.location.search;

				// é¿å…åœ¨éªŒè¯é¡µé¢ä¸Šæ— é™é‡å®šå‘
				if (currentPath !== '/auth' && currentPath !== '/auth.html') {
					var redirectUrl = '/auth?redirect=' + encodeURIComponent(currentPath + currentSearch);
					window.location.href = redirectUrl;
				}
			}
		})();
	</script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Apple Color Emoji', Roboto, sans-serif;
			background: #F5F5F0;
			min-height: 100vh;
			padding: 20px;
		}

		@keyframes gradientShift {
			0% {
				background-position: 0% 50%;
			}

			50% {
				background-position: 100% 50%;
			}

			100% {
				background-position: 0% 50%;
			}
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			background: #FFFFFF;
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			overflow: hidden;
		}

		.header {
			background: linear-gradient(135deg, #6B8E9F 0%, #9CAE9A 100%);
			color: white;
			padding: 30px;
			text-align: center;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}

		.header p {
			opacity: 0.8;
			font-size: 1.1em;
		}

		.tabs {
			display: flex;
			background: #958E9E;
		}

		.tab {
			flex: 1;
			padding: 20px;
			text-align: center;
			color: #000;
			cursor: pointer;
			transition: background 0.3s;
			border: none;
			font-size: 1.1em;
			background: #E8E6EA;
		}

		.tab.active {
			background: #6B8E9F;
			color: white;
		}

		.tab:hover {
			background: #5A7A8A;
			color: white;
		}

		.content {
			padding: 30px;
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.input-group {
			margin-bottom: 25px;
		}

		.input-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			color: #2c3e50;
		}

		.input-group input,
		.input-group textarea,
		.input-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 1em;
			transition: border-color 0.3s;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Apple Color Emoji', Arial, sans-serif;
			background: #FFFFFF;
		}

		.input-group textarea {
			min-height: 120px;
			resize: vertical;
		}

		.input-group input:focus,
		.input-group textarea:focus,
		.input-group select:focus {
			outline: none;
			border-color: #6B8E9F;
		}

		.input-group select {
			cursor: pointer;
		}

		/* è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ */
		.custom-select {
			position: relative;
			width: 100%;
		}

		.select-display {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 1em;
			background: #FFFFFF;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: border-color 0.3s;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Apple Color Emoji', Arial, sans-serif;
		}

		.select-display:hover {
			border-color: #6B8E9F;
		}

		.select-display.active {
			border-color: #6B8E9F;
			border-bottom-left-radius: 0;
			border-bottom-right-radius: 0;
		}

		.select-arrow {
			transition: transform 0.3s;
			color: #666;
		}

		.select-display.active .select-arrow {
			transform: rotate(180deg);
		}

		.select-options {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #FFFFFF;
			border: 2px solid #6B8E9F;
			border-top: none;
			border-radius: 0 0 8px 8px;
			max-height: 200px;
			overflow-y: auto;
			z-index: 1000;
			display: none;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.select-options.show {
			display: block;
		}

		.select-option {
			padding: 12px 15px;
			cursor: pointer;
			transition: background-color 0.2s;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Apple Color Emoji', Arial, sans-serif;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.select-option .fi {
			width: 20px;
			height: 15px;
			border-radius: 2px;
		}

		.select-option:hover {
			background-color: #F5F5F0;
		}

		.select-option.selected {
			background-color: #6B8E9F;
			color: white;
		}

		.btn {
			background: #6B8E9F;
			color: white;
			border: none;
			padding: 12px 25px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 1em;
			transition: background 0.3s;
			margin-right: 10px;
			margin-bottom: 10px;
		}

		.btn:hover {
			background: #5A7A8A;
		}

		.btn.danger {
			background: #C59292;
		}

		.btn.danger:hover {
			background: #B37F7F;
		}

		.btn.success {
			background: #9CAE9A;
		}

		.btn.success:hover {
			background: #8A9B88;
		}

		.list {
			background: #F5F5F0;
			border-radius: 8px;
			padding: 20px;
			margin-top: 20px;
		}

		.list-item {
			background: #FFFFFF;
			padding: 15px;
			margin-bottom: 10px;
			border-radius: 6px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			transition: all 0.3s ease;
		}

		.list-item:last-child {
			margin-bottom: 0;
		}

		.item-actions {
			display: flex;
			gap: 8px;
			flex-shrink: 0;
		}

		/* æ–°æ·»åŠ é¡¹ç›®çš„é«˜äº®æ ·å¼ */
		.list-item.newly-added {
			background: #9CAE9A;
			border: 2px solid #9CAE9A;
			box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
			animation: highlightPulse 3s ease-in-out;
			scroll-margin-top: 20px;
			/* æ»šåŠ¨æ—¶çš„é¡¶éƒ¨è¾¹è· */
		}

		@keyframes highlightPulse {
			0% {
				transform: scale(1);
				box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
			}

			25% {
				transform: scale(1.02);
				box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
			}

			50% {
				transform: scale(1);
				box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
			}

			75% {
				transform: scale(1.01);
				box-shadow: 0 5px 10px rgba(39, 174, 96, 0.25);
			}

			100% {
				transform: scale(1);
				box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
			}
		}

		.item-info {
			flex: 1;
		}

		.item-name {
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 5px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.btn-icon {
			background: none;
			border: none;
			cursor: pointer;
			font-size: 16px;
			padding: 2px 6px;
			border-radius: 4px;
			transition: background-color 0.2s;
			opacity: 0.7;
		}

		.btn-icon:hover {
			background-color: rgba(0, 0, 0, 0.05);
			opacity: 1;
		}

		.item-details {
			color: #7f8c8d;
			font-size: 0.9em;
			/* é™åˆ¶å®½åº¦é¿å…æŒ¤å ç¼–è¾‘æŒ‰é’®ä½ç½®ï¼Œæ”¯æŒå¤šè¡Œæ˜¾ç¤º */
			max-width: calc(100% - 120px);
			word-wrap: break-word;
			word-break: break-all;
			line-height: 1.4;
		}

		.subscription-links {
			background: #DDE8DD;
			padding: 20px;
			border-radius: 8px;
			margin-top: 20px;
		}

		.subscription-links h3 {
			color: #9CAE9A;
			margin-bottom: 15px;
		}

		.link-item {
			background: #FFFFFF;
			padding: 15px;
			border-radius: 6px;
			margin-bottom: 10px;
			border-left: 4px solid #9CAE9A;
		}

		.link-item:last-child {
			margin-bottom: 0;
		}

		.link-url {
			font-family: monospace;
			background: #f1f2f6;
			padding: 8px 12px;
			border-radius: 4px;
			word-break: break-all;
			margin-top: 8px;
		}

		.message {
			padding: 12px 15px;
			border-radius: 6px;
			margin-bottom: 15px;
			display: none;
			white-space: pre-line;
			/* æ”¯æŒæ¢è¡Œæ˜¾ç¤º */
			font-weight: 500;
		}

		.message.success {
			background: #DDE8DD;
			color: #155724;
			border: 1px solid #9CAE9A;
		}

		.message.error {
			background: #E8CFCF;
			color: #5A5A5A;
			border: 1px solid #C59292;
		}

		.message.info {
			background: #D9E5E9;
			color: #0c5460;
			border: 1px solid #6B8E9F;
		}

		/* æŒ‰é’®å’Œæ¶ˆæ¯çš„æ¨ªå‘å¸ƒå±€ */
		.action-bar {
			display: flex;
			align-items: flex-start;
			gap: 15px;
			margin-bottom: 20px;
		}

		.action-buttons {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.action-message {
			flex: 1;
			min-width: 0;
		}

		.action-message .message {
			margin: 0;
			max-height: 200px;
			overflow-y: auto;
		}

		.empty-state {
			text-align: center;
			color: #7f8c8d;
			padding: 40px;
		}

		.empty-state i {
			font-size: 3em;
			margin-bottom: 15px;
			opacity: 0.5;
		}

		@media (max-width: 768px) {

			/* å®¹å™¨ä¼˜åŒ– */
			.container {
				margin: 10px;
				border-radius: 8px;
			}

			.header {
				padding: 20px;
			}

			.header h1 {
				font-size: 2em;
			}

			.content {
				padding: 15px;
				/* å‡å°‘å†…è¾¹è· */
			}

			/* æ ‡ç­¾é¡µä¼˜åŒ– - ä¿æŒæ°´å¹³å¸ƒå±€ä½†è°ƒæ•´å­—ä½“ */
			.tab {
				padding: 15px 10px;
				font-size: 0.9em;
			}

			/* åˆ—è¡¨é¡¹å¸ƒå±€ä¼˜åŒ– */
			.list-item {
				flex-direction: column;
				align-items: flex-start;
				padding: 12px;
				/* å‡å°‘å†…è¾¹è· */
			}

			/* æŒ‰é’®åŒºåŸŸï¼šä¸¤è¡Œå¸ƒå±€ */
			.item-actions {
				display: flex;
				flex-direction: column;
				gap: 8px;
				width: 100%;
				margin-top: 12px;
			}

			/* ç¬¬ä¸€è¡Œï¼šå¯¼å…¥Clashå’Œå¤åˆ¶é“¾æ¥ */
			.item-actions-row-1 {
				display: flex;
				gap: 8px;
			}

			/* ç¬¬äºŒè¡Œï¼šç®¡ç†ã€é‡å‘½åã€åˆ é™¤ */
			.item-actions-row-2 {
				display: flex;
				gap: 6px;
			}

			/* ç¬¬ä¸€è¡ŒæŒ‰é’®æ ·å¼ */
			.item-actions-row-1 .btn {
				flex: 1;
				padding: 8px 12px;
				font-size: 0.85em;
				margin: 0;
				text-align: center;
				white-space: nowrap;
				min-height: 36px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* ç¬¬äºŒè¡ŒæŒ‰é’®æ ·å¼ï¼ˆæ›´ç´§å‡‘ï¼‰ */
			.item-actions-row-2 .btn {
				flex: 1;
				padding: 6px 8px;
				font-size: 0.8em;
				margin: 0;
				text-align: center;
				white-space: nowrap;
				min-height: 32px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* è®¢é˜…é›†åˆç¬¬ä¸€è¡Œæœ‰3ä¸ªæŒ‰é’®çš„ç‰¹æ®Šæ ·å¼ */
			#subCollectionList .item-actions-row-1 {
				display: flex;
				gap: 6px;
				/* ç¨å¾®ç¼©å°é—´è· */
			}

			#subCollectionList .item-actions-row-1 .btn {
				flex: 1;
				padding: 7px 6px;
				/* ç¨å¾®è°ƒæ•´padding */
				font-size: 0.8em;
				/* ç¨å¾®ç¼©å°å­—ä½“ */
				min-height: 36px;
			}

			/* è®¢é˜…é›†åˆç¬¬äºŒè¡Œæœ‰3ä¸ªæŒ‰é’®çš„æ ·å¼ */
			#subCollectionList .item-actions-row-2 {
				display: flex;
				gap: 6px;
			}

			#subCollectionList .item-actions-row-2 .btn {
				flex: 1;
				padding: 6px 6px;
				/* ä¿æŒç´§å‡‘ */
				font-size: 0.8em;
				min-height: 32px;
			}

			/* æ“ä½œæ ä¼˜åŒ– */
			.action-bar {
				flex-direction: column;
				gap: 10px;
			}

			.action-buttons {
				gap: 8px;
			}

			.action-buttons .btn {
				padding: 10px 16px;
				font-size: 0.9em;
			}

			/* æ¨¡æ€æ¡†ä¼˜åŒ– */
			.modal-content {
				width: 95%;
				margin: 2% auto;
			}

			.modal-body {
				padding: 15px;
			}

			/* è¾“å…¥æ¡†ä¼˜åŒ– */
			.input-group {
				margin-bottom: 20px;
			}

			.input-group input,
			.input-group textarea,
			.input-group select {
				font-size: 16px;
				/* é˜²æ­¢iOSç¼©æ”¾ */
			}
		}

		/* è¶…å°å±å¹•ä¼˜åŒ–ï¼ˆå°äº480pxï¼‰ */
		@media (max-width: 480px) {
			.header h1 {
				font-size: 1.8em;
			}

			.content {
				padding: 12px;
			}

			.item-actions .btn {
				padding: 6px 8px;
				font-size: 0.8em;
				min-height: 32px;
			}

			.tab {
				padding: 12px 8px;
				font-size: 0.85em;
			}
		}

		/* è¿›åº¦æ¡æ ·å¼ */
		.progress-container {
			margin-top: 15px;
			padding: 0;
			background: transparent;
			border-radius: 0;
			border: none;
		}

		.progress-bar {
			width: 100%;
			height: 30px;
			background-color: #e9ecef;
			border-radius: 15px;
			overflow: hidden;
			position: relative;
			border: 2px solid #dee2e6;
		}

		.progress-fill {
			height: 100%;
			background: #9CAE9A;
			border-radius: 13px;
			width: 0%;
			transition: width 0.5s ease-in-out;
			position: relative;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.progress-text {
			color: white;
			font-weight: bold;
			font-size: 14px;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			padding: 0 10px;
		}

		/* æ“ä½œè¾“å‡ºæ¡†æ ·å¼ */
		.operation-output {
			margin: 15px 0;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			background: #F5F5F0;
			max-height: 400px;
			overflow: hidden;
			width: 100%;
		}

		.output-header {
			background: #e9ecef;
			padding: 10px 15px;
			border-bottom: 1px solid #dee2e6;
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-weight: bold;
			font-size: 14px;
		}

		.btn-close {
			background: none;
			border: none;
			font-size: 18px;
			cursor: pointer;
			color: #6c757d;
			padding: 0;
			width: 20px;
			height: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-close:hover {
			color: #dc3545;
		}

		.output-content {
			padding: 15px;
			max-height: 350px;
			overflow-y: auto;
			font-family: 'Courier New', monospace;
			font-size: 13px;
			line-height: 1.5;
			white-space: pre-wrap;
			word-wrap: break-word;
			background: #ffffff;
			border-top: 1px solid #dee2e6;
		}

		.progress-fill::after {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			bottom: 0;
			right: 0;
			background: linear-gradient(90deg,
					transparent,
					rgba(255, 255, 255, 0.2),
					transparent);
			animation: shimmer 2s infinite;
		}

		@keyframes shimmer {
			0% {
				transform: translateX(-100%);
			}

			100% {
				transform: translateX(100%);
			}
		}

		.btn:disabled {
			background: #6c757d;
			cursor: not-allowed;
			opacity: 0.6;
		}

		.btn:disabled:hover {
			background: #6c757d;
		}

		/* å¤åˆ¶é“¾æ¥åŒºåŸŸæ ·å¼ */
		.copy-links-container {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin: 20px 0;
		}

		.copy-link-single {
			display: flex;
			justify-content: center;
			margin: 0 0 20px 0;
		}

		.copy-links-container .link-item,
		.copy-link-single .link-item {
			background: #6B8E9F;
			border: 1px solid #A8BBC5;
			border-radius: 8px;
			padding: 10px;
			display: flex;
			flex-direction: column;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			transition: all 0.2s ease;
		}

		.copy-link-single .link-item {
			width: 100%;
			max-width: 750px;
		}

		.copy-links-container .link-item:hover,
		.copy-link-single .link-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		.copy-links-container .link-item strong,
		.copy-link-single .link-item strong {
			font-size: 15px;
			color: #6B8E9F;
			margin-bottom: 6px;
			font-weight: 600;
			text-align: center;
		}

		.copy-links-container .link-url,
		.copy-link-single .link-url {
			background: rgba(255, 255, 255, 0.8);
			border: 1px solid #8BA4AE;
			border-radius: 6px;
			padding: 6px 10px;
			font-family: 'Courier New', monospace;
			font-size: 13px;
			word-break: break-all;
			color: #424242;
			flex: 1;
			margin-bottom: 8px;
			min-height: 28px;
			display: flex;
			align-items: center;
			line-height: 1.3;
		}

		.copy-links-container .btn,
		.copy-link-single .btn {
			background: #6B8E9F;
			color: white;
			border: none;
			font-size: 13px;
			font-weight: 500;
			padding: 6px 16px;
			height: 30px;
			border-radius: 6px;
			transition: all 0.2s ease;
		}

		.copy-links-container .btn:hover,
		.copy-link-single .btn:hover {
			background: #5A7A8A;
			transform: translateY(-1px);
			box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
		}

		@media (max-width: 768px) {
			.copy-links-container {
				grid-template-columns: 1fr;
				gap: 12px;
				margin: 15px 0;
			}

			.copy-link-single .link-item {
				max-width: none;
			}

			/* ç§»åŠ¨ç«¯é€‚é…ï¼šä¿¡æ¯åŒºåŸŸå¯ä»¥ä½¿ç”¨å…¨å®½ï¼Œå› ä¸ºæŒ‰é’®åœ¨ä¸‹æ–¹ */
			.item-details {
				max-width: 100%;
			}

			/* ç§»åŠ¨ç«¯å¤é€‰æ¡†å¸ƒå±€ä¼˜åŒ– */
			.list-item .item-name {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.list-item .item-name .checkbox-wrapper {
				flex-shrink: 0;
				width: 20px;
				height: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* ç§»åŠ¨ç«¯ç®¡ç†èŠ‚ç‚¹åˆ é™¤æŒ‰é’® - æ”¹ä¸ºæ¨ªå‘æ’å¸ƒ */
			.node-delete-btn {
				padding: 6px 10px !important;
				font-size: 0.85em !important;
				flex-shrink: 0;
				margin-left: 8px;
				white-space: nowrap;
				/* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
			}

			/* ç®¡ç†èŠ‚ç‚¹ä¸­é™åˆ¶ä¿¡æ¯å®½åº¦ */
			#collectionProxyList .item-info {
				max-width: calc(100% - 40px);
			}

			/* ç®¡ç†è®¢é˜…æŒ‰é’®å¸ƒå±€ */
			#collectionSubList .item-actions {
				display: flex;
				gap: 6px;
				margin-top: 8px;
				width: 100%;
			}

			#collectionSubList .item-actions .btn {
				flex: 1;
				padding: 6px 10px;
				font-size: 0.85em;
			}

			.list-item .item-name .name-text {
				flex: 1;
				min-width: 0;
				text-align: left;
			}

			/* ç§»åŠ¨ç«¯ä¿¡æ¯åŒºåŸŸå·¦å¯¹é½ */
			.item-info {
				text-align: left;
				width: 100%;
				display: flex;
				flex-direction: column;
				align-items: flex-start;
			}

			.item-details {
				text-align: left;
				margin-left: 28px;
			}

			/* ä¸»ç•Œé¢é›†åˆåˆ—è¡¨å®Œå…¨å·¦å¯¹é½ */
			#collectionList .item-info,
			#subCollectionList .item-info {
				text-align: left;
			}

			#collectionList .item-name,
			#subCollectionList .item-name {
				text-align: left;
				margin-left: 0;
			}

			#collectionList .item-details,
			#subCollectionList .item-details {
				text-align: left;
				margin-left: 0;
			}

			/* éšè—åŸæ¥ä½ç½®çš„å¤é€‰æ¡† */
			.list-item>.collection-proxy-checkbox,
			.list-item>.collection-subscription-checkbox {
				display: none;
			}
		}

		/* é€‰æ‹©åŠŸèƒ½æ ·å¼ */
		.proxy-checkbox,
		.subscription-checkbox,
		.collection-proxy-checkbox,
		.collection-subscription-checkbox {
			margin-right: 12px;
			transform: scale(1.2);
			cursor: pointer;
			accent-color: #6B8E9F;
		}

		/* æ¡Œé¢ç«¯ç®¡ç†è®¢é˜…ç•Œé¢è®¢é˜…é“¾æ¥æ˜¾ç¤ºä¼˜åŒ– */
		@media (min-width: 769px) {
			#collectionSubList .list-item {
				position: relative;
				overflow: visible;
				/* å…è®¸item-detailsæº¢å‡º */
			}

			#collectionSubList .item-info {
				position: relative;
				z-index: 1;
				/* ç¡®ä¿ä¿¡æ¯åŒºåŸŸåœ¨ä¸Šå±‚ */
			}

			#collectionSubList .item-details {
				max-width: calc(100% + 100px);
				/* å‘å³å»¶ä¼¸100px */
				width: auto;
				word-wrap: break-word;
				word-break: break-all;
				white-space: normal;
				/* å…è®¸æ¢è¡Œ */
				line-height: 1.4;
				padding-right: 10px;
				/* æ·»åŠ å³å†…è¾¹è·ï¼Œé¿å…è´´è¾¹ */
			}

			#collectionSubList .item-actions {
				position: relative;
				z-index: 2;
				/* ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«é®æŒ¡ */
				margin-top: 10px;
				/* ä¸ä¸Šæ–¹å†…å®¹ä¿æŒé—´è· */
			}
		}

		/* æ¡Œé¢ç«¯éšè—ç§»åŠ¨ç«¯å¤é€‰æ¡† */
		.mobile-checkbox {
			display: none;
		}

		/* æ¡Œé¢ç«¯å¤é€‰æ¡†æ ·å¼ */
		.desktop-checkbox {
			display: block;
		}

		/* ç§»åŠ¨ç«¯å¤é€‰æ¡†æ ·å¼ */
		@media (max-width: 768px) {

			/* æ˜¾ç¤ºç§»åŠ¨ç«¯å¤é€‰æ¡†ï¼Œéšè—åŸä½ç½®å¤é€‰æ¡† */
			.mobile-checkbox {
				display: block;
				margin: 0;
				transform: scale(1.2);
				position: relative;
				top: 0;
				left: 0;
				pointer-events: auto;
				z-index: 10;
				-webkit-tap-highlight-color: transparent;
				touch-action: manipulation;
			}

			/* éšè—åŸæ¥ä½ç½®çš„å¤é€‰æ¡† */
			.list-item>.collection-proxy-checkbox:not(.mobile-checkbox),
			.list-item>.collection-subscription-checkbox:not(.mobile-checkbox) {
				display: none;
			}

			/* ç§»åŠ¨ç«¯èŠ‚ç‚¹å’Œè®¢é˜…é›†åˆä¸­çš„å¸ƒå±€ */
			#collectionProxyList .list-item,
			#collectionSubList .list-item {
				display: flex;
				flex-direction: column;
				position: relative;
				padding: 12px;
			}

			/* å¤é€‰æ¡†å®šä½åœ¨åç§°å’Œè¯¦æƒ…çš„ä¸­é—´é«˜åº¦ */
			#collectionProxyList .checkbox-wrapper,
			#collectionSubList .checkbox-wrapper {
				position: absolute;
				left: 15px;
				/* æ¢å¤å¤é€‰æ¡†å·¦è¾¹è· */
				top: 28px;
				/* è°ƒæ•´åˆ°åç§°å’Œé“¾æ¥çš„ä¸­é—´ä½ç½® */
				z-index: 10;
			}

			/* ç§»åŠ¨ç«¯ç®¡ç†èŠ‚ç‚¹ç•Œé¢ä¿¡æ¯åŒºåŸŸè°ƒæ•´ */
			#collectionProxyList .item-info {
				margin-left: 0px;
				/* ä¿¡æ¯åŒºåŸŸä»å·¦è¾¹ç•Œå¼€å§‹ */
				margin-right: 10px;
				/* å³ä¾§ç•™å‡ºç©ºé—´ */
				width: calc(100% - 10px);
				/* å æ®å‡ ä¹å…¨éƒ¨å®½åº¦ */
				margin-bottom: 10px;
				/* ä¸æŒ‰é’®ä¿æŒé—´è· */
				padding-left: -15px;
				/* è´Ÿå†…è¾¹è·ï¼Œè®©å†…å®¹æ›´é å·¦ */
			}

			/* ç§»åŠ¨ç«¯ç®¡ç†è®¢é˜…ç•Œé¢ä¿¡æ¯åŒºåŸŸè°ƒæ•´ - éœ€è¦ä¸ºå¤é€‰æ¡†ç•™å‡ºç©ºé—´ */
			#collectionSubList .item-info {
				margin-left: 40px;
				/* ä¸ºå¤é€‰æ¡†ç•™å‡ºç©ºé—´ï¼Œé¿å…é‡å  */
				margin-right: 10px;
				/* å³ä¾§ç•™å‡ºç©ºé—´ */
				width: calc(100% - 60px);
				/* å‡å»å·¦å³è¾¹è·ï¼Œç¡®ä¿ä¸è¶…å‡ºå¡ç‰‡ */
				margin-bottom: 10px;
				/* ä¸æŒ‰é’®ä¿æŒé—´è· */
				padding-left: 0px;
				/* ç§»é™¤å†…è¾¹è· */
			}

			/* åç§°æ ·å¼ä¼˜åŒ– */
			#collectionProxyList .item-name,
			#collectionSubList .item-name {
				display: block;
				font-weight: 600;
				color: #2c3e50;
				margin-bottom: 5px;
				word-wrap: break-word;
				word-break: break-all;
				line-height: 1.4;
			}

			/* ç§»åŠ¨ç«¯èŠ‚ç‚¹è¯¦æƒ…æ ·å¼ä¼˜åŒ–ï¼Œé˜²æ­¢å†…å®¹è¶…å‡º */
			#collectionProxyList .item-details {
				margin-left: 0;
				color: #7f8c8d;
				font-size: 0.85em;
				word-wrap: break-word;
				word-break: break-all;
				line-height: 1.3;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				/* æœ€å¤šæ˜¾ç¤º2è¡Œ */
				line-clamp: 2;
				/* æ ‡å‡†å±æ€§ï¼Œå¢å¼ºå…¼å®¹æ€§ */
				-webkit-box-orient: vertical;
			}

			/* ç§»åŠ¨ç«¯è®¢é˜…é“¾æ¥æ ·å¼ä¼˜åŒ–ï¼Œæ˜¾ç¤ºå®Œæ•´é“¾æ¥ */
			#collectionSubList .item-details {
				margin-left: 0;
				color: #7f8c8d;
				font-size: 0.85em;
				word-wrap: break-word;
				word-break: break-all;
				line-height: 1.3;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				line-clamp: 4;
				/* æœ€å¤šæ˜¾ç¤º4è¡Œï¼Œç¡®ä¿é•¿é“¾æ¥æ˜¾ç¤ºå®Œæ•´ */
				-webkit-box-orient: vertical;
			}

			/* æŒ‰é’®åŒºåŸŸç¡®ä¿ä¸ä¼šä¸å¤é€‰æ¡†é‡å  */
			#collectionSubList .item-actions {
				width: 100%;
				display: flex;
				gap: 6px;
				margin-top: 8px;
				margin-left: 0;
			}

			/* èŠ‚ç‚¹é›†åˆçš„åˆ é™¤æŒ‰é’® */
			#collectionProxyList .node-delete-btn {
				position: absolute;
				right: 12px;
				top: 28px;
				/* ä¸å¤é€‰æ¡†åŒé«˜ */
				padding: 6px 10px;
				font-size: 0.85em;
			}

			/* ç§»åŠ¨ç«¯è°ƒæ•´èŠ‚ç‚¹é›†åˆä¿¡æ¯åŒºåŸŸå®½åº¦ï¼Œä¸ºåˆ é™¤æŒ‰é’®ç•™ç©ºé—´ */
			#collectionProxyList .item-info {
				width: calc(100% - 120px);
				/* å†å¾€å·¦20pxï¼Œä¸ºåˆ é™¤æŒ‰é’®ç•™æ›´å¤šç©ºé—´ */
				padding-right: 0;
				/* ç§»é™¤å³å†…è¾¹è· */
			}
		}

		.list-item {
			display: flex;
			align-items: center;
			padding: 15px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			margin-bottom: 10px;
			background: #FFFFFF;
			transition: all 0.2s ease;
		}

		.list-item:hover {
			border-color: #6B8E9F;
			box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
		}

		.list-item.selected {
			border-color: #6B8E9F;
			background: #F5F5F0;
		}

		.selection-info {
			padding: 8px 16px;
			background: #D9E5E9;
			border-radius: 6px;
			margin-bottom: 16px;
			font-size: 14px;
			color: #6B8E9F;
			border-left: 4px solid #6B8E9F;
		}

		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			background: #bdc3c7 !important;
		}

		.btn:disabled:hover {
			transform: none !important;
			box-shadow: none !important;
		}

		/* å¯¼å…¥ClashæŒ‰é’®ç‰¹æ®Šæ ·å¼ */
		.btn.clash-import {
			background: #C4BDCE;
			color: white;
		}

		.btn.clash-import:hover {
			background: #B3AABE;
		}

		/* æ¡Œé¢ç«¯æŒ‰é’®å¸ƒå±€ */
		@media (min-width: 769px) {
			.item-actions {
				display: flex;
				flex-direction: row;
				gap: 10px;
				align-items: center;
			}

			.item-actions-row-1,
			.item-actions-row-2 {
				display: contents;
			}

			.item-actions .btn {
				padding: 8px 16px;
				font-size: 0.9em;
				white-space: nowrap;
				margin: 0;
				min-height: auto;
			}
		}

		/* æ–°èŠ‚ç‚¹é«˜äº®æ ·å¼ - ç»Ÿä¸€ä½¿ç”¨ç»¿è‰² */
		.list-item.newly-added {
			background: #9CAE9A;
			border: 2px solid #9CAE9A;
			box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
			animation: highlightPulse 3s ease-in-out;
			scroll-margin-top: 20px;
		}

		@keyframes highlightPulse {

			0%,
			100% {
				transform: scale(1);
			}

			50% {
				transform: scale(1.02);
			}
		}

		/* è¾“å‡ºæ¡†æ ·å¼ */
		.output-section {
			margin-top: 20px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			overflow: hidden;
			background: #ffffff;
		}

		.output-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			background: #F5F5F0;
			border-bottom: 1px solid #e0e0e0;
		}

		.output-header label {
			font-weight: 600;
			color: #2c3e50;
			margin: 0;
			font-size: 14px;
		}

		.btn.small {
			padding: 6px 12px;
			font-size: 12px;
			min-width: auto;
		}

		.output-box {
			height: 80px;
			overflow-y: auto;
			padding: 12px;
			background: #ffffff;
			font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
			font-size: 13px;
			line-height: 1.4;
		}

		.output-placeholder {
			color: #6c757d;
			font-style: italic;
			text-align: center;
			padding: 40px 0;
		}

		.output-entry {
			margin-bottom: 8px;
			padding: 6px 8px;
			border-radius: 4px;
			border-left: 3px solid #6B8E9F;
			word-wrap: break-word;
		}

		.output-entry.success {
			background: #DDE8DD;
			border-left-color: #9CAE9A;
			color: #155724;
		}

		.output-entry.error {
			background: #E8CFCF;
			border-left-color: #C59292;
			color: #5A5A5A;
		}

		.output-entry.warning {
			background: #fff3cd;
			border-left-color: #ffc107;
			color: #856404;
		}

		.output-entry.info {
			background: #D9E5E9;
			border-left-color: #6B8E9F;
			color: #0c5460;
		}

		.output-timestamp {
			font-size: 11px;
			color: #6c757d;
			margin-right: 8px;
		}

		/* ç¡®è®¤åˆ é™¤å¼¹çª—æ ·å¼ */
		.confirm-modal {
			display: none;
			position: fixed;
			z-index: 2000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(5px);
		}

		.confirm-modal-content {
			background: #F5F5F0;
			margin: 15% auto;
			padding: 0;
			border-radius: 16px;
			width: 90%;
			max-width: 450px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			animation: confirmModalSlideIn 0.3s ease-out;
			overflow: hidden;
		}

		@keyframes confirmModalSlideIn {
			from {
				opacity: 0;
				transform: translateY(-50px) scale(0.9);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		.confirm-modal-header {
			background: #C59292;
			color: white;
			padding: 20px 25px;
			text-align: center;
		}

		.confirm-modal-header h3 {
			margin: 0;
			font-size: 1.3em;
			font-weight: 600;
		}

		.confirm-modal-body {
			padding: 25px;
			text-align: center;
		}

		.confirm-modal-body p {
			margin: 0 0 20px 0;
			font-size: 1.1em;
			color: #2c3e50;
			line-height: 1.5;
		}

		.confirm-modal-actions {
			display: flex;
			gap: 12px;
			justify-content: center;
		}

		.confirm-btn {
			padding: 12px 24px;
			border: none;
			border-radius: 8px;
			font-size: 1em;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			min-width: 100px;
		}

		.confirm-btn.danger {
			background: #C59292;
			color: white;
		}

		.confirm-btn.danger:hover {
			background: #B37F7F;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
		}

		.confirm-btn.secondary {
			background: #F5F5F0;
			color: #6c757d;
			border: 2px solid #e9ecef;
		}

		.confirm-btn.secondary:hover {
			background: #e9ecef;
			color: #495057;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}

		/* å¼¹çª—æ ·å¼ */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
			background-color: white;
			position: fixed;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
			padding: 0;
			border-radius: 12px;
			width: 90%;
			max-width: 800px;
			max-height: 85vh;
			overflow: hidden;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
		}

		.modal-header {
			background: #958E9E;
			color: white;
			padding: 20px;
			border-radius: 12px 12px 0 0;
			position: relative;
		}

		.modal-header h3 {
			margin: 0;
			font-size: 1.5em;
			display: inline-block;
		}

		.modal-body {
			padding: 20px;
			max-height: calc(85vh - 60px);
			overflow-y: auto;
		}


		.close {
			color: white;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			line-height: 1;
			position: absolute;
			right: 20px;
			top: 50%;
			transform: translateY(-50%);
			padding: 5px;
			min-width: 30px;
			text-align: center;
		}

		.close:hover {
			opacity: 0.7;
		}

		/* ç§»åŠ¨ç«¯ä¼˜åŒ–å…³é—­æŒ‰é’® */
		@media (max-width: 768px) {
			.close {
				font-size: 32px;
				padding: 8px;
				min-width: 40px;
				right: 15px;
			}
		}

		/* è®¢é˜…å…ƒä¿¡æ¯æ ·å¼ */
		.subscription-meta {
			margin-top: 8px;
			padding-top: 8px;
			border-top: 1px solid #ecf0f1;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		/* æµé‡ä¿¡æ¯æ ·å¼ */
		.traffic-info {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: 0.85em;
		}

		.traffic-label {
			color: #7f8c8d;
			font-weight: 500;
		}

		.traffic-value {
			color: #2c3e50;
			font-weight: 600;
		}

		/* åˆ°æœŸä¿¡æ¯æ ·å¼ */
		.expire-info {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: 0.85em;
		}

		.expire-label {
			font-size: 1.1em;
		}

		.expire-value {
			color: #7f8c8d;
			font-weight: 500;
		}

		/* ç§»åŠ¨ç«¯è®¢é˜…å…ƒä¿¡æ¯ä¼˜åŒ– */
		@media (max-width: 768px) {
			.subscription-meta {
				margin-top: 8px;
				padding-top: 8px;
				margin-left: 0;
				border-top: 1px dashed #e0e0e0;
				display: flex;
				flex-direction: column;
				gap: 6px;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
			}

			#collectionSubList .subscription-meta {
				margin-left: 0;
				width: 100%;
				max-width: 100%;
			}

			.traffic-info,
			.expire-info {
				flex: 0 0 auto;
				width: 100%;
				max-width: 100%;
				font-size: 0.75em;
				background: #F5F5F0;
				padding: 6px 10px;
				border-radius: 4px;
				box-sizing: border-box;
				overflow: hidden;
				word-wrap: break-word;
			}

			/* ç§»åŠ¨ç«¯è®¢é˜…é¡¹æ•´ä½“å¸ƒå±€è°ƒæ•´ - ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ */
			#collectionSubList .subscription-item {
				overflow: visible;
			}

			#collectionSubList .subscription-item .item-info {
				margin-left: 40px;
				margin-right: 10px;
				width: calc(100% - 50px);
				max-width: calc(100% - 50px);
				box-sizing: border-box;
			}

			#collectionSubList .item-details {
				margin-left: 0;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
			}
		}

		/* æ¡Œé¢ç«¯è®¢é˜…é¡¹å¸ƒå±€ä¼˜åŒ– */
		@media (min-width: 769px) {
			.subscription-item .item-info {
				display: flex;
				flex-direction: column;
			}

			.subscription-meta {
				max-width: 500px;
				flex-direction: row;
				gap: 16px;
			}

			.traffic-info,
			.expire-info {
				background: transparent;
				padding: 0;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>Clash Sub</h1>
			<p>è½»æ¾ç®¡ç†ä½ çš„ä»£ç†èŠ‚ç‚¹å’Œè®¢é˜…é“¾æ¥</p>
		</div>

		<div class="tabs">
			<button class="tab active" onclick="switchTab('proxy-collections')">èŠ‚ç‚¹é›†åˆ</button>
			<button class="tab" onclick="switchTab('sub-collections')">è®¢é˜…é›†åˆ</button>
		</div>

		<div class="content">
			<!-- èŠ‚ç‚¹é›†åˆç®¡ç†éƒ¨åˆ† -->
			<div id="proxy-collections" class="section active">
				<h2>èŠ‚ç‚¹é›†åˆç®¡ç†</h2>
				<p>åˆ›å»ºå’Œç®¡ç†å¤šä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹æ•´åˆè®¢é˜…é“¾æ¥</p>

				<div class="action-bar">
					<div class="action-buttons">
						<button class="btn" onclick="createProxyCollection()">åˆ›å»ºæ–°é›†åˆ</button>
					</div>
					<div class="action-message">
						<div id="collectionMessage" class="message"></div>
					</div>
				</div>

				<div class="list" id="collectionList">
					<div class="empty-state">
						<div>ğŸ“</div>
						<p>æš‚æ— èŠ‚ç‚¹é›†åˆï¼Œè¯·åˆ›å»ºæ–°é›†åˆ</p>
					</div>
				</div>
			</div>

			<!-- è®¢é˜…é›†åˆç®¡ç†éƒ¨åˆ† -->
			<div id="sub-collections" class="section">
				<h2>è®¢é˜…é›†åˆç®¡ç†</h2>
				<p>åˆ›å»ºå’Œç®¡ç†å¤šä¸ªç‹¬ç«‹çš„è®¢é˜…æ•´åˆé“¾æ¥</p>

				<div class="action-bar">
					<div class="action-buttons">
						<button class="btn" onclick="createSubCollection()">åˆ›å»ºæ–°é›†åˆ</button>
					</div>
					<div class="action-message">
						<div id="subCollectionMessage" class="message"></div>
					</div>
				</div>

				<div class="list" id="subCollectionList">
					<div class="empty-state">
						<div>ğŸ“‚</div>
						<p>æš‚æ— è®¢é˜…é›†åˆï¼Œè¯·åˆ›å»ºæ–°é›†åˆ</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- èŠ‚ç‚¹é›†åˆç®¡ç†å¼¹çª— -->
	<div id="proxyCollectionModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 id="proxyCollectionModalTitle">ç®¡ç†èŠ‚ç‚¹é›†åˆ</h3>
				<span class="close" onclick="closeProxyCollectionModal()">&times;</span>
			</div>
			<div class="modal-body">
				<!-- å¤åˆ¶é“¾æ¥ -->
				<div class="copy-link-single">
					<div class="link-item">
						<strong>é›†åˆè®¢é˜…é“¾æ¥</strong>
						<div class="link-url" id="currentCollectionLink"></div>
						<button class="btn success" onclick="copyCurrentCollectionLink()">å¤åˆ¶é“¾æ¥</button>
					</div>
				</div>

				<!-- æ·»åŠ èŠ‚ç‚¹ -->
				<div class="input-group">
					<label for="collectionProxyUrl">æ·»åŠ èŠ‚ç‚¹ï¼ˆæ”¯æŒé“¾æ¥å’ŒJSONæ ¼å¼ï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ ï¼‰</label>
					<textarea id="collectionProxyUrl"
						placeholder="æ”¯æŒä»¥ä¸‹æ ¼å¼(æ¯è¡Œä¸€ä¸ª)ï¼š&#10;1. èŠ‚ç‚¹é“¾æ¥&#10;2. JSONæ ¼å¼&#10;3. æ··åˆæ ¼å¼ï¼šé“¾æ¥å’ŒJSONå¯ä»¥æ··åˆè¾“å…¥"></textarea>
				</div>

				<div class="input-group">
					<label for="collectionRegionSelect">åœ°åŒºé€‰æ‹©</label>
					<div class="custom-select" id="collectionRegionSelect">
						<div class="select-display" onclick="toggleCollectionRegionDropdown()">
							<span id="selectedCollectionRegion">ğŸŒ è‡ªåŠ¨è¯†åˆ«åœ°åŒº</span>
							<span class="select-arrow">â–¼</span>
						</div>
						<div class="select-options" id="collectionRegionOptions">
							<div class="select-option" data-value="auto">ğŸŒ è‡ªåŠ¨è¯†åˆ«åœ°åŒº</div>
							<div class="select-option" data-value="US"><span class="fi fi-us"></span> ç¾å›½</div>
							<div class="select-option" data-value="HK"><span class="fi fi-hk"></span> é¦™æ¸¯</div>
							<div class="select-option" data-value="JP"><span class="fi fi-jp"></span> æ—¥æœ¬</div>
							<div class="select-option" data-value="KR"><span class="fi fi-kr"></span> éŸ©å›½</div>
							<div class="select-option" data-value="SG"><span class="fi fi-sg"></span> æ–°åŠ å¡</div>
							<div class="select-option" data-value="TW"><span class="fi fi-tw"></span> å°æ¹¾</div>
							<div class="select-option" data-value="GB"><span class="fi fi-gb"></span> è‹±å›½</div>
							<div class="select-option" data-value="DE"><span class="fi fi-de"></span> å¾·å›½</div>
							<div class="select-option" data-value="FR"><span class="fi fi-fr"></span> æ³•å›½</div>
							<div class="select-option" data-value="CA"><span class="fi fi-ca"></span> åŠ æ‹¿å¤§</div>
							<div class="select-option" data-value="AU"><span class="fi fi-au"></span> æ¾³å¤§åˆ©äºš</div>
							<div class="select-option" data-value="RU"><span class="fi fi-ru"></span> ä¿„ç½—æ–¯</div>
							<div class="select-option" data-value="IN"><span class="fi fi-in"></span> å°åº¦</div>
							<div class="select-option" data-value="BR"><span class="fi fi-br"></span> å·´è¥¿</div>
							<div class="select-option" data-value="TR"><span class="fi fi-tr"></span> åœŸè€³å…¶</div>
							<div class="select-option" data-value="TH"><span class="fi fi-th"></span> æ³°å›½</div>
							<div class="select-option" data-value="MY"><span class="fi fi-my"></span> é©¬æ¥è¥¿äºš</div>
							<div class="select-option" data-value="ID"><span class="fi fi-id"></span> å°åº¦å°¼è¥¿äºš</div>
							<div class="select-option" data-value="PH"><span class="fi fi-ph"></span> è²å¾‹å®¾</div>
							<div class="select-option" data-value="VN"><span class="fi fi-vn"></span> è¶Šå—</div>
							<div class="select-option" data-value="AR"><span class="fi fi-ar"></span> é˜¿æ ¹å»·</div>
							<div class="select-option" data-value="CL"><span class="fi fi-cl"></span> æ™ºåˆ©</div>
							<div class="select-option" data-value="MX"><span class="fi fi-mx"></span> å¢¨è¥¿å“¥</div>
							<div class="select-option" data-value="ZA"><span class="fi fi-za"></span> å—é</div>
							<div class="select-option" data-value="EG"><span class="fi fi-eg"></span> åŸƒåŠ</div>
							<div class="select-option" data-value="AE"><span class="fi fi-ae"></span> é˜¿è”é…‹</div>
							<div class="select-option" data-value="IL"><span class="fi fi-il"></span> ä»¥è‰²åˆ—</div>
							<div class="select-option" data-value="NL"><span class="fi fi-nl"></span> è·å…°</div>
							<div class="select-option" data-value="IT"><span class="fi fi-it"></span> æ„å¤§åˆ©</div>
							<div class="select-option" data-value="ES"><span class="fi fi-es"></span> è¥¿ç­ç‰™</div>
							<div class="select-option" data-value="SE"><span class="fi fi-se"></span> ç‘å…¸</div>
							<div class="select-option" data-value="NO"><span class="fi fi-no"></span> æŒªå¨</div>
							<div class="select-option" data-value="FI"><span class="fi fi-fi"></span> èŠ¬å…°</div>
							<div class="select-option" data-value="DK"><span class="fi fi-dk"></span> ä¸¹éº¦</div>
							<div class="select-option" data-value="CH"><span class="fi fi-ch"></span> ç‘å£«</div>
							<div class="select-option" data-value="AT"><span class="fi fi-at"></span> å¥¥åœ°åˆ©</div>
							<div class="select-option" data-value="BE"><span class="fi fi-be"></span> æ¯”åˆ©æ—¶</div>
							<div class="select-option" data-value="PL"><span class="fi fi-pl"></span> æ³¢å…°</div>
							<div class="select-option" data-value="CZ"><span class="fi fi-cz"></span> æ·å…‹</div>
							<div class="select-option" data-value="HU"><span class="fi fi-hu"></span> åŒˆç‰™åˆ©</div>
							<div class="select-option" data-value="RO"><span class="fi fi-ro"></span> ç½—é©¬å°¼äºš</div>
							<div class="select-option" data-value="BG"><span class="fi fi-bg"></span> ä¿åŠ åˆ©äºš</div>
							<div class="select-option" data-value="HR"><span class="fi fi-hr"></span> å…‹ç½—åœ°äºš</div>
							<div class="select-option" data-value="RS"><span class="fi fi-rs"></span> å¡å°”ç»´äºš</div>
							<div class="select-option" data-value="UA"><span class="fi fi-ua"></span> ä¹Œå…‹å…°</div>
							<div class="select-option" data-value="GR"><span class="fi fi-gr"></span> å¸Œè…Š</div>
							<div class="select-option" data-value="PT"><span class="fi fi-pt"></span> è‘¡è„ç‰™</div>
							<div class="select-option" data-value="IE"><span class="fi fi-ie"></span> çˆ±å°”å…°</div>
							<div class="select-option" data-value="LU"><span class="fi fi-lu"></span> å¢æ£®å ¡</div>
							<div class="select-option" data-value="IS"><span class="fi fi-is"></span> å†°å²›</div>
							<div class="select-option" data-value="NZ"><span class="fi fi-nz"></span> æ–°è¥¿å…°</div>
							<div class="select-option" data-value="CO"><span class="fi fi-co"></span> å“¥ä¼¦æ¯”äºš</div>
							<div class="select-option" data-value="PE"><span class="fi fi-pe"></span> ç§˜é²</div>
						</div>
					</div>
				</div>

				<div class="action-bar">
					<div class="action-buttons">
						<button class="btn" onclick="addProxyToCurrentCollection()">æ·»åŠ èŠ‚ç‚¹</button>
						<button class="btn" onclick="selectAllCollectionProxies()"
							id="selectAllCollectionProxiesBtn">å…¨é€‰</button>
						<button class="btn" onclick="copySelectedCollectionProxies()"
							id="copySelectedCollectionProxiesBtn" disabled>å¤åˆ¶é€‰ä¸­</button>
						<button class="btn danger" onclick="deleteSelectedCollectionProxies()"
							id="deleteSelectedCollectionProxiesBtn" disabled>åˆ é™¤é€‰ä¸­</button>
					</div>
					<div class="action-message">
						<div id="collectionProxySelectionInfo" class="selection-info" style="display: none;"></div>
						<div id="collectionProxyMessage" class="message"></div>
					</div>
				</div>

				<!-- èŠ‚ç‚¹ç®¡ç†è¾“å‡ºæ¡† -->
				<div class="output-section">
					<div class="output-header">
						<label>æ“ä½œæ—¥å¿—</label>
						<button class="btn small" onclick="clearCollectionOutput()">æ¸…ç©ºæ—¥å¿—</button>
					</div>
					<div class="output-box" id="collectionOutputBox">
						<div class="output-placeholder">æš‚æ— æ“ä½œè®°å½•</div>
					</div>
				</div>

				<!-- èŠ‚ç‚¹åˆ—è¡¨ -->
				<div class="list" id="collectionProxyList">
					<div class="empty-state">
						<div>ğŸ“¡</div>
						<p>æš‚æ— èŠ‚ç‚¹ï¼Œè¯·æ·»åŠ èŠ‚ç‚¹é“¾æ¥</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- è®¢é˜…é›†åˆç®¡ç†å¼¹çª— -->
	<div id="subCollectionModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 id="subCollectionModalTitle">ç®¡ç†è®¢é˜…é›†åˆ</h3>
				<span class="close" onclick="closeSubCollectionModal()">&times;</span>
			</div>
			<div class="modal-body">
				<!-- å¤åˆ¶é“¾æ¥ -->
				<div class="copy-link-single">
					<div class="link-item">
						<strong>é›†åˆè®¢é˜…é“¾æ¥</strong>
						<div class="link-url" id="currentSubCollectionLink"></div>
						<button class="btn success" onclick="copyCurrentSubCollectionLink()">å¤åˆ¶é“¾æ¥</button>
					</div>
				</div>

				<!-- æ·»åŠ è®¢é˜… -->
				<div class="input-group">
					<label for="collectionSubUrl">æ·»åŠ è®¢é˜…é“¾æ¥ï¼ˆæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ªé“¾æ¥ï¼‰</label>
					<textarea id="collectionSubUrl" placeholder="è¯·è¾“å…¥è®¢é˜…é“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ªé“¾æ¥"></textarea>
				</div>

				<div class="action-bar">
					<div class="action-buttons">
						<button class="btn" onclick="addSubscriptionToCurrentCollection()">æ·»åŠ è®¢é˜…</button>
						<button class="btn" onclick="activeDetectionForCurrentCollection()"
							id="currentCollectionActiveDetectionBtn">æ´»è·ƒæ£€æµ‹</button>
						<button class="btn" onclick="selectAllCollectionSubscriptions()"
							id="selectAllCollectionSubscriptionsBtn">å…¨é€‰</button>
						<button class="btn" onclick="copySelectedCollectionSubscriptions()"
							id="copySelectedCollectionSubscriptionsBtn" disabled>å¤åˆ¶é€‰ä¸­</button>
						<button class="btn danger" onclick="deleteSelectedCollectionSubscriptions()"
							id="deleteSelectedCollectionSubscriptionsBtn" disabled>åˆ é™¤é€‰ä¸­</button>
					</div>
				</div>

				<!-- è®¢é˜…ç®¡ç†è¾“å‡ºæ¡† -->
				<div class="output-section">
					<div class="output-header">
						<label>æ“ä½œæ—¥å¿—</label>
						<button class="btn small" onclick="clearCollectionSubOutput()">æ¸…ç©ºæ—¥å¿—</button>
					</div>
					<div class="output-box" id="collectionSubOutputBox">
						<div class="output-placeholder">æš‚æ— æ“ä½œè®°å½•</div>
					</div>
				</div>

				<div class="action-message">
					<div id="collectionSubscriptionSelectionInfo" class="selection-info" style="display: none;">
					</div>
					<div id="collectionSubMessage" class="message"></div>
				</div>

				<!-- è®¢é˜…åˆ—è¡¨ -->
				<div class="list" id="collectionSubList">
					<div class="empty-state">
						<div>ğŸ”—</div>
						<p>æš‚æ— è®¢é˜…ï¼Œè¯·æ·»åŠ è®¢é˜…é“¾æ¥</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>

	<script>
		let proxyCollections = []; // èŠ‚ç‚¹é›†åˆ
		let subCollections = []; // è®¢é˜…é›†åˆ
		let newlyAddedCollectionSubscriptions = new Set(); // è·Ÿè¸ªè®¢é˜…é›†åˆä¸­æ–°æ·»åŠ çš„è®¢é˜…
		let newlyAddedCollectionProxies = new Set(); // è·Ÿè¸ªé›†åˆä¸­æ–°æ·»åŠ çš„èŠ‚ç‚¹

		// å½“å‰ç®¡ç†çš„é›†åˆ
		let currentManagingCollection = null;
		let currentManagingSubCollection = null;
		let selectedCollectionRegionValue = 'auto';

		// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
		window.addEventListener('load', function () {
			// è®¾ç½®è®¢é˜…é“¾æ¥
			const origin = window.location.origin;

			// è®¾ç½®é¡¶éƒ¨å¤åˆ¶é“¾æ¥

			loadProxyCollections();
			loadSubCollections();
			// å¯åŠ¨è®¢é˜…åç§°å®šæ—¶æ›´æ–°ï¼ˆæ¯å°æ—¶ï¼‰

			// æ·»åŠ é›†åˆåœ°åŒºé€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
			setupCollectionRegionSelector();
		});

		// åˆ‡æ¢æ ‡ç­¾é¡µ
		function switchTab(tab) {
			document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

			event.target.classList.add('active');
			document.getElementById(tab).classList.add('active');
		}

		// å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
		function copyToClipboard(text) {
			if (navigator.clipboard) {
				navigator.clipboard.writeText(text).then(() => {
					// å¤åˆ¶æˆåŠŸ
				}).catch(err => {
					// é™çº§æ–¹æ¡ˆ
					fallbackCopyTextToClipboard(text);
				});
			} else {
				// é™çº§æ–¹æ¡ˆ
				fallbackCopyTextToClipboard(text);
			}
		}

		// é™çº§å¤åˆ¶æ–¹æ¡ˆ
		function fallbackCopyTextToClipboard(text) {
			const textArea = document.createElement('textarea');
			textArea.value = text;
			textArea.style.position = 'fixed';
			textArea.style.left = '-999999px';
			textArea.style.top = '-999999px';
			document.body.appendChild(textArea);
			textArea.focus();
			textArea.select();

			try {
				document.execCommand('copy');
			} catch (err) {
				console.error('å¤åˆ¶å¤±è´¥:', err);
			}

			document.body.removeChild(textArea);
		}

		// æ˜¾ç¤ºæ¶ˆæ¯
		function showMessage(elementId, message, type = 'success') {
			const messageEl = document.getElementById(elementId);
			messageEl.textContent = message;
			messageEl.className = 'message ' + type;
			messageEl.style.display = 'block';

			// æ ¹æ®æ¶ˆæ¯ç±»å‹å’Œå†…å®¹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é—´
			let displayTime;
			if (type === 'error') {
				displayTime = 8000; // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º8ç§’
			} else if (message.includes('æ´»è·ƒæ£€æµ‹å®Œæˆ') && message.includes('ç§»é™¤çš„è®¢é˜…')) {
				displayTime = 15000; // æ´»è·ƒæ£€æµ‹ç»“æœåŒ…å«ç§»é™¤ä¿¡æ¯æ—¶æ˜¾ç¤º15ç§’
			} else if (message.includes('æ´»è·ƒæ£€æµ‹å®Œæˆ')) {
				displayTime = 8000; // æ´»è·ƒæ£€æµ‹ç»“æœæ˜¾ç¤º8ç§’
			} else {
				displayTime = 3000; // å…¶ä»–ä¿¡æ¯æ˜¾ç¤º3ç§’
			}

			setTimeout(() => {
				messageEl.style.display = 'none';
			}, displayTime);
		}

		// åŠ è½½èŠ‚ç‚¹é›†åˆåˆ—è¡¨
		async function loadProxyCollections() {
			try {
				const response = await fetch('/api/proxy-collections');
				proxyCollections = await response.json();
				renderProxyCollections();
			} catch (error) {
				console.error('åŠ è½½èŠ‚ç‚¹é›†åˆå¤±è´¥:', error);
			}
		}

		// æ¸²æŸ“èŠ‚ç‚¹é›†åˆåˆ—è¡¨
		function renderProxyCollections() {
			const listEl = document.getElementById('collectionList');

			if (proxyCollections.length === 0) {
				listEl.innerHTML = '<div class="empty-state"><div>ğŸ“</div><p>æš‚æ— èŠ‚ç‚¹é›†åˆï¼Œè¯·åˆ›å»ºæ–°é›†åˆ</p></div>';
				return;
			}

			let html = '';
			for (let i = 0; i < proxyCollections.length; i++) {
				const collection = proxyCollections[i];
				const proxyCount = collection.proxies.length;
				const origin = window.location.origin;
				const collectionUrl = `${origin}/clash/proxies/${collection.id}`;

				html += '<div class="list-item" data-index="' + i + '">';
				html += '<div class="item-info">';
				html += '<div class="item-name">' + collection.name + '</div>';
				html += '<div class="item-details">èŠ‚ç‚¹æ•°é‡: ' + proxyCount + ' | è®¢é˜…é“¾æ¥: ' + collectionUrl + '</div>';
				html += '</div>';
				html += '<div class="item-actions">';
				html += '<div class="item-actions-row-1">';
				html += '<button class="btn clash-import" onclick="importToClash(\'' + collection.id + '\')">å¯¼å…¥Clash</button>';
				html += '<button class="btn" onclick="copyCollectionLink(\'' + collection.id + '\')">å¤åˆ¶é“¾æ¥</button>';
				html += '</div>';
				html += '<div class="item-actions-row-2">';
				html += '<button class="btn" onclick="manageCollection(\'' + collection.id + '\')">ç®¡ç†èŠ‚ç‚¹</button>';
				html += '<button class="btn" onclick="renameCollection(\'' + collection.id + '\')">é‡å‘½å</button>';
				html += '<button class="btn danger" onclick="deleteCollection(\'' + collection.id + '\')">åˆ é™¤</button>';
				html += '</div>';
				html += '</div>';
				html += '</div>';
			}
			listEl.innerHTML = html;
		}

		// åˆ›å»ºæ–°çš„èŠ‚ç‚¹é›†åˆ
		async function createProxyCollection() {
			const name = prompt('è¯·è¾“å…¥é›†åˆåç§°ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤åç§°ï¼‰:');
			if (name === null) return; // ç”¨æˆ·å–æ¶ˆ

			try {
				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'create', data: { name } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('collectionMessage', result.error, 'error');
				} else {
					showMessage('collectionMessage', 'èŠ‚ç‚¹é›†åˆåˆ›å»ºæˆåŠŸ');
					loadProxyCollections();
				}
			} catch (error) {
				showMessage('collectionMessage', 'åˆ›å»ºèŠ‚ç‚¹é›†åˆå¤±è´¥', 'error');
			}
		}

		// ç”ŸæˆClash URL Schemeé“¾æ¥
		function generateClashScheme(subscriptionUrl) {
			const encodedUrl = encodeURIComponent(subscriptionUrl);
			// æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ï¼Œç§»åŠ¨ç«¯ä½¿ç”¨clashmeta://ï¼Œæ¡Œé¢ç«¯ä½¿ç”¨clash://
			const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
			const scheme = isMobile ? 'clashmeta' : 'clash';
			return `${scheme}://install-config?url=${encodedUrl}`;
		}

		// å¯¼å…¥åˆ°Clashï¼ˆèŠ‚ç‚¹é›†åˆï¼‰
		function importToClash(collectionId) {
			const origin = window.location.origin;
			const subscriptionUrl = `${origin}/clash/proxies/${collectionId}`;
			const clashScheme = generateClashScheme(subscriptionUrl);
			window.location.href = clashScheme;
		}

		// å¤åˆ¶é›†åˆè®¢é˜…é“¾æ¥
		function copyCollectionLink(collectionId) {
			const origin = window.location.origin;
			const url = `${origin}/clash/proxies/${collectionId}`;
			copyToClipboard(url);
			showMessage('collectionMessage', 'è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
		}

		// é‡å‘½åé›†åˆ
		async function renameCollection(collectionId) {
			const collection = proxyCollections.find(c => c.id === collectionId);
			if (!collection) return;

			const newName = prompt('è¯·è¾“å…¥æ–°çš„é›†åˆåç§°:', collection.name);
			if (newName === null || newName.trim() === '') return;

			try {
				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'rename', data: { id: collectionId, newName } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('collectionMessage', result.error, 'error');
				} else {
					showMessage('collectionMessage', 'é›†åˆé‡å‘½åæˆåŠŸ');
					loadProxyCollections();
				}
			} catch (error) {
				showMessage('collectionMessage', 'é‡å‘½åé›†åˆå¤±è´¥', 'error');
			}
		}

		// åˆ é™¤é›†åˆ
		async function deleteCollection(collectionId) {
			const collection = proxyCollections.find(c => c.id === collectionId);
			if (!collection) return;

			if (!confirm(`ç¡®å®šè¦åˆ é™¤é›†åˆ "${collection.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;

			try {
				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'delete', data: { id: collectionId } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('collectionMessage', result.error, 'error');
				} else {
					showMessage('collectionMessage', 'é›†åˆåˆ é™¤æˆåŠŸ');
					loadProxyCollections();
				}
			} catch (error) {
				showMessage('collectionMessage', 'åˆ é™¤é›†åˆå¤±è´¥', 'error');
			}
		}

		// ç®¡ç†é›†åˆä¸­çš„èŠ‚ç‚¹
		function manageCollection(collectionId) {
			const collection = proxyCollections.find(c => c.id === collectionId);
			if (!collection) return;

			currentManagingCollection = collection;

			// è®¾ç½®å¼¹çª—æ ‡é¢˜å’Œé“¾æ¥
			document.getElementById('proxyCollectionModalTitle').textContent = `ç®¡ç†èŠ‚ç‚¹é›†åˆ: ${collection.name}`;
			const origin = window.location.origin;
			const collectionUrl = `${origin}/clash/proxies/${collection.id}`;
			document.getElementById('currentCollectionLink').textContent = collectionUrl;

			// æ¸…ç©ºè¾“å…¥æ¡†
			document.getElementById('collectionProxyUrl').value = '';
			document.getElementById('collectionProxyMessage').style.display = 'none';

			// æ¸²æŸ“èŠ‚ç‚¹åˆ—è¡¨
			renderCollectionProxies();

			// æ˜¾ç¤ºå¼¹çª—
			document.getElementById('proxyCollectionModal').style.display = 'block';
		}

		// å…³é—­èŠ‚ç‚¹é›†åˆç®¡ç†å¼¹çª—
		function closeProxyCollectionModal() {
			document.getElementById('proxyCollectionModal').style.display = 'none';
			currentManagingCollection = null;
		}

		// æ¸²æŸ“é›†åˆä¸­çš„èŠ‚ç‚¹åˆ—è¡¨
		function renderCollectionProxies() {
			if (!currentManagingCollection) return;

			const listEl = document.getElementById('collectionProxyList');
			const proxies = currentManagingCollection.proxies;

			if (proxies.length === 0) {
				listEl.innerHTML = '<div class="empty-state"><div>ğŸ“¡</div><p>æš‚æ— èŠ‚ç‚¹ï¼Œè¯·æ·»åŠ èŠ‚ç‚¹é“¾æ¥</p></div>';
				updateCollectionProxySelectionUI();
				return;
			}

			let html = '';
			let firstNewlyAddedIndex = -1;

			for (let i = 0; i < proxies.length; i++) {
				const proxy = proxies[i];
				const isNewlyAdded = newlyAddedCollectionProxies.has(proxy.name);
				const highlightClass = isNewlyAdded ? ' newly-added' : '';

				// è®°å½•ç¬¬ä¸€ä¸ªæ–°æ·»åŠ èŠ‚ç‚¹çš„ä½ç½®
				if (isNewlyAdded && firstNewlyAddedIndex === -1) {
					firstNewlyAddedIndex = i;
				}

				html += '<div class="list-item' + highlightClass + '" data-index="' + i + '">';
				// æ¡Œé¢ç«¯å¤é€‰æ¡†
				html += '<input type="checkbox" class="collection-proxy-checkbox desktop-checkbox" data-index="' + i + '" onchange="syncCheckboxState(' + i + ', \'proxy\')">';
				// ç§»åŠ¨ç«¯å¤é€‰æ¡†å®¹å™¨
				html += '<div class="checkbox-wrapper">';
				html += '<input type="checkbox" class="collection-proxy-checkbox mobile-checkbox" data-index="' + i + '" onchange="syncCheckboxState(' + i + ', \'proxy\')">';
				html += '</div>';
				html += '<div class="item-info">';
				html += '<div class="item-name">';
				html += '<span class="name-text">' + proxy.name + '</span>';
				html += '<button class="btn-icon" onclick="renameCollectionProxy(' + i + ')" title="é‡å‘½å">âœï¸</button>';
				html += '</div>';
				html += '<div class="item-details">' + proxy.type + ' | ';
				html += '<span class="server-text">' + proxy.server + '</span>';
				html += '<button class="btn-icon" onclick="changeProxyServer(' + i + ')" title="ä¿®æ”¹IP">ğŸ”§</button>';
				html += ':' + proxy.port + '</div>';
				html += '</div>';
				// åˆ é™¤æŒ‰é’®
				html += '<button class="btn danger node-delete-btn" onclick="deleteSingleCollectionProxy(' + i + ')">åˆ é™¤</button>';
				html += '</div>';
			}
			listEl.innerHTML = html;
			updateCollectionProxySelectionUI();

			// å¦‚æœæœ‰æ–°æ·»åŠ çš„èŠ‚ç‚¹ï¼Œæ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªæ–°èŠ‚ç‚¹
			if (firstNewlyAddedIndex !== -1) {
				setTimeout(() => {
					const listItems = document.querySelectorAll('#collectionProxyList .list-item');
					if (listItems[firstNewlyAddedIndex]) {
						listItems[firstNewlyAddedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
					}
				}, 100);
			}

			// 15ç§’åç§»é™¤é«˜äº®
			if (newlyAddedCollectionProxies.size > 0) {
				setTimeout(() => {
					newlyAddedCollectionProxies.clear();
					// é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤é«˜äº®æ ·å¼
					renderCollectionProxies();
				}, 15000);
			}
		}

		// ========== è¾“å‡ºæ¡†ç®¡ç†åŠŸèƒ½ ==========

		// æ·»åŠ è¾“å‡ºæ—¥å¿—
		function addCollectionOutput(message, type = 'info') {
			const outputBox = document.getElementById('collectionOutputBox');
			const placeholder = outputBox.querySelector('.output-placeholder');

			if (placeholder) {
				placeholder.remove();
			}

			const timestamp = new Date().toLocaleTimeString();
			const entry = document.createElement('div');
			entry.className = `output-entry ${type}`;
			entry.innerHTML = `
				<span class="output-timestamp">[${timestamp}]</span>
				<span class="output-message">${message}</span>
			`;

			outputBox.appendChild(entry);
			outputBox.scrollTop = outputBox.scrollHeight;
		}

		// æ¸…ç©ºè¾“å‡ºæ—¥å¿—
		function clearCollectionOutput() {
			const outputBox = document.getElementById('collectionOutputBox');
			outputBox.innerHTML = '<div class="output-placeholder">æš‚æ— æ“ä½œè®°å½•</div>';
		}





		// ========== é›†åˆèŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½ ==========

		// æ›´æ–°é›†åˆèŠ‚ç‚¹é€‰æ‹©UIçŠ¶æ€
		function updateCollectionProxySelectionUI() {
			// åŒæ­¥æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å¤é€‰æ¡†çŠ¶æ€
			document.querySelectorAll('#collectionProxyList .list-item').forEach((item, index) => {
				const desktopCheckbox = item.querySelector('.collection-proxy-checkbox:not(.mobile-checkbox)');
				const mobileCheckbox = item.querySelector('.collection-proxy-checkbox.mobile-checkbox');

				if (desktopCheckbox && mobileCheckbox) {
					// å¦‚æœå…¶ä¸­ä¸€ä¸ªè¢«é€‰ä¸­ï¼ŒåŒæ­¥åˆ°å¦ä¸€ä¸ª
					if (desktopCheckbox.checked !== mobileCheckbox.checked) {
						mobileCheckbox.checked = desktopCheckbox.checked;
					}
				}
			});

			const checkboxes = document.querySelectorAll('.collection-proxy-checkbox:not(.mobile-checkbox)');
			const selectedCheckboxes = document.querySelectorAll('.collection-proxy-checkbox:not(.mobile-checkbox):checked');
			const selectedCount = selectedCheckboxes.length;
			const totalCount = checkboxes.length;

			// æ›´æ–°é€‰æ‹©ä¿¡æ¯æ˜¾ç¤º
			const selectionInfo = document.getElementById('collectionProxySelectionInfo');
			const selectAllBtn = document.getElementById('selectAllCollectionProxiesBtn');
			const copyBtn = document.getElementById('copySelectedCollectionProxiesBtn');
			const deleteBtn = document.getElementById('deleteSelectedCollectionProxiesBtn');

			if (selectedCount > 0) {
				selectionInfo.style.display = 'block';
				selectionInfo.textContent = `å·²é€‰æ‹© ${selectedCount} / ${totalCount} ä¸ªèŠ‚ç‚¹`;
				copyBtn.disabled = false;
				deleteBtn.disabled = false;
			} else {
				selectionInfo.style.display = 'none';
				copyBtn.disabled = true;
				deleteBtn.disabled = true;
			}

			// æ›´æ–°å…¨é€‰æŒ‰é’®æ–‡æœ¬
			if (selectedCount === totalCount && totalCount > 0) {
				selectAllBtn.textContent = 'å–æ¶ˆå…¨é€‰';
			} else {
				selectAllBtn.textContent = 'å…¨é€‰';
			}

			// æ›´æ–°åˆ—è¡¨é¡¹çš„é€‰ä¸­æ ·å¼
			document.querySelectorAll('#collectionProxyList .list-item').forEach((item, index) => {
				const checkbox = item.querySelector('.collection-proxy-checkbox:not(.mobile-checkbox)');
				if (checkbox && checkbox.checked) {
					item.classList.add('selected');
				} else {
					item.classList.remove('selected');
				}
			});
		}

		// å…¨é€‰/å–æ¶ˆå…¨é€‰é›†åˆèŠ‚ç‚¹
		function selectAllCollectionProxies() {
			const checkboxes = document.querySelectorAll('.collection-proxy-checkbox:not(.mobile-checkbox)');
			const allChecked = Array.from(checkboxes).every(cb => cb.checked);

			// åŒæ—¶æ›´æ–°æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å¤é€‰æ¡†
			document.querySelectorAll('.collection-proxy-checkbox').forEach(cb => {
				cb.checked = !allChecked;
			});

			updateCollectionProxySelectionUI();
		}

		// è·å–é€‰ä¸­çš„é›†åˆèŠ‚ç‚¹ç´¢å¼•
		function getSelectedCollectionProxyIndexes() {
			const selectedCheckboxes = document.querySelectorAll('.collection-proxy-checkbox:not(.mobile-checkbox):checked');
			return Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
		}

		// å¤åˆ¶é€‰ä¸­é›†åˆèŠ‚ç‚¹çš„JSON
		function copySelectedCollectionProxies() {
			const selectedIndexes = getSelectedCollectionProxyIndexes();
			if (selectedIndexes.length === 0) {
				showCollectionMessage('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„èŠ‚ç‚¹', 'warning');
				return;
			}

			const selectedProxies = selectedIndexes.map(index => currentManagingCollection.proxies[index]);
			// ä¿®æ”¹ä¸ºå•è¡Œæ ¼å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸€è¡Œï¼Œå–æ¶ˆæœ€å¤–å±‚çš„[]
			const jsonData = selectedProxies.map(proxy => JSON.stringify(proxy)).join('\n');

			navigator.clipboard.writeText(jsonData).then(() => {
				showCollectionMessage(`å·²å¤åˆ¶ ${selectedIndexes.length} ä¸ªèŠ‚ç‚¹çš„JSONæ•°æ®`, 'success');
			}).catch(() => {
				// é™çº§æ–¹æ¡ˆ
				const textArea = document.createElement('textarea');
				textArea.value = jsonData;
				document.body.appendChild(textArea);
				textArea.select();
				document.execCommand('copy');
				document.body.removeChild(textArea);
				showCollectionMessage(`å·²å¤åˆ¶ ${selectedIndexes.length} ä¸ªèŠ‚ç‚¹çš„JSONæ•°æ®`, 'success');
			});
		}

		// åˆ é™¤é€‰ä¸­çš„é›†åˆèŠ‚ç‚¹
		async function deleteSelectedCollectionProxies() {
			const selectedIndexes = getSelectedCollectionProxyIndexes();
			if (selectedIndexes.length === 0) {
				showCollectionMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹', 'warning');
				return;
			}

			showConfirmModal(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIndexes.length} ä¸ªèŠ‚ç‚¹å—ï¼Ÿ`, async function () {
				try {
					const response = await fetch('/api/proxy-collections', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							action: 'batchDeleteProxy',
							collectionId: currentManagingCollection.id,
							indexes: selectedIndexes
						})
					});

					const result = await response.json();
					if (result.success) {
						showCollectionMessage(`æˆåŠŸåˆ é™¤ ${selectedIndexes.length} ä¸ªèŠ‚ç‚¹`, 'success');

						// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
						await loadProxyCollections();
						currentManagingCollection = proxyCollections.find(c => c.id === currentManagingCollection.id);
						renderCollectionProxies();
					} else {
						showCollectionMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
					}
				} catch (error) {
					showCollectionMessage('åˆ é™¤èŠ‚ç‚¹å¤±è´¥', 'error');
				}
			});
		}

		// å¤åˆ¶å½“å‰é›†åˆé“¾æ¥
		function copyCurrentCollectionLink() {
			if (!currentManagingCollection) return;
			const origin = window.location.origin;
			const url = `${origin}/clash/proxies/${currentManagingCollection.id}`;
			copyToClipboard(url);
			showCollectionMessage('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
			addCollectionOutput(`å·²å¤åˆ¶é›†åˆè®¢é˜…é“¾æ¥: ${url}`, 'info');
		}

		// æ˜¾ç¤ºé›†åˆç®¡ç†æ¶ˆæ¯
		function showCollectionMessage(message, type = 'success') {
			// åŸæœ‰çš„ä¸´æ—¶æ¶ˆæ¯æ˜¾ç¤º
			const messageEl = document.getElementById('collectionProxyMessage');
			messageEl.textContent = message;
			messageEl.className = 'message ' + type;
			messageEl.style.display = 'block';

			// æ·»åŠ åˆ°å›ºå®šè¾“å‡ºæ¡†
			addCollectionOutput(message, type);

			let displayTime;
			if (type === 'error') {
				displayTime = 8000;
			} else {
				displayTime = 3000;
			}

			setTimeout(() => {
				messageEl.style.display = 'none';
			}, displayTime);
		}

		// åˆ‡æ¢é›†åˆåœ°åŒºä¸‹æ‹‰èœå•
		function toggleCollectionRegionDropdown() {
			const display = document.querySelector('#collectionRegionSelect .select-display');
			const options = document.getElementById('collectionRegionOptions');

			display.classList.toggle('active');
			options.classList.toggle('show');
		}

		// é€‰æ‹©é›†åˆåœ°åŒºé€‰é¡¹
		function selectCollectionRegionOption(value, text) {
			selectedCollectionRegionValue = value;
			document.getElementById('selectedCollectionRegion').innerHTML = text;
			document.getElementById('collectionRegionOptions').classList.remove('show');
			document.querySelector('#collectionRegionSelect .select-display').classList.remove('active');
		}

		// å‘å½“å‰é›†åˆæ·»åŠ èŠ‚ç‚¹ï¼ˆæ”¯æŒé“¾æ¥å’ŒJSONæ ¼å¼è‡ªåŠ¨è¯†åˆ«ï¼‰
		async function addProxyToCurrentCollection() {
			if (!currentManagingCollection) return;

			const inputContent = document.getElementById('collectionProxyUrl').value.trim();
			if (!inputContent) {
				showCollectionMessage('è¯·è¾“å…¥èŠ‚ç‚¹ä¿¡æ¯', 'error');
				return;
			}

			try {
				// å°è¯•è§£æè¾“å…¥å†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«æ ¼å¼
				const parsedData = parseCollectionProxyInput(inputContent, selectedCollectionRegionValue);

				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(parsedData)
				});

				const result = await response.json();

				if (result.error) {
					showCollectionMessage(result.error, 'error');
				} else {
					const successCount = result.successCount || result.addedCount || 0;
					let message;
					if (successCount > 0) {
						message = `æˆåŠŸæ·»åŠ  ${successCount} ä¸ªèŠ‚ç‚¹`;
					} else {
						message = 'æœªèƒ½æ·»åŠ èŠ‚ç‚¹';
					}

					const skipMessages = [];
					if (result.duplicateCount > 0) {
						skipMessages.push(`${result.duplicateCount} ä¸ªé‡å¤èŠ‚ç‚¹`);
					}
					if (result.errorCount > 0) {
						skipMessages.push(`${result.errorCount} ä¸ªæ ¼å¼é”™è¯¯èŠ‚ç‚¹`);
					}
					if (skipMessages.length > 0) {
						message += `ï¼Œè·³è¿‡ ${skipMessages.join('ã€')}`;
					}

					showCollectionMessage(message);

					// æ¸…ç©ºè¾“å…¥æ¡†
					document.getElementById('collectionProxyUrl').value = '';

					// æ¸…ç©ºä¹‹å‰çš„é«˜äº®è®°å½•å¹¶è®°å½•æ–°æ·»åŠ çš„èŠ‚ç‚¹
					newlyAddedCollectionProxies.clear();
					if (result.addedProxies && result.addedProxies.length > 0) {
						result.addedProxies.forEach(proxy => {
							newlyAddedCollectionProxies.add(proxy.name);
						});
					}

					// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
					await loadProxyCollections();
					currentManagingCollection = proxyCollections.find(c => c.id === currentManagingCollection.id);
					renderCollectionProxies();

					// æ˜¾ç¤ºæ·»åŠ æˆåŠŸçš„ä¿¡æ¯
					if (newlyAddedCollectionProxies.size > 0) {
						addCollectionOutput(`å·²é«˜äº®æ˜¾ç¤º ${newlyAddedCollectionProxies.size} ä¸ªæ–°æ·»åŠ çš„èŠ‚ç‚¹`, 'info');
					}
				}
			} catch (error) {
				showCollectionMessage(error.message || 'æ·»åŠ èŠ‚ç‚¹å¤±è´¥', 'error');
			}
		}

		// è§£æé›†åˆä»£ç†è¾“å…¥å†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«é“¾æ¥å’ŒJSONæ ¼å¼
		function parseCollectionProxyInput(inputContent, region) {
			const lines = inputContent.split('\n').map(line => line.trim()).filter(line => line);
			const urlLines = [];
			const jsonObjects = [];

			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				const lineNumber = i + 1;

				// æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç†é“¾æ¥
				if (line.match(/^(vmess|vless|ss|ssr|hysteria|hysteria2|hy2|trojan|tuic|socks5|snell|wg|wireguard|mieru|anytls|ssh|https?):\/\//)) {
					urlLines.push(line);
				}
				// æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„å•è¡ŒJSONå¯¹è±¡ï¼ˆæ”¯æŒå‰ç¼€å­—ç¬¦ï¼‰
				else {
					// å»é™¤è¡Œé¦–çš„åˆ¶è¡¨ç¬¦ã€æ¨ªæ ã€ç©ºæ ¼ç­‰å‰ç¼€å­—ç¬¦
					const trimmedLine = line.replace(/^[\s\-]*/, '').trim();

					if (trimmedLine.startsWith('{') && trimmedLine.endsWith('}')) {
						try {
							const parsed = JSON.parse(trimmedLine);
							// ä¸åœ¨å‰ç«¯éªŒè¯JSONå­—æ®µå®Œæ•´æ€§ï¼Œäº¤ç»™åç«¯å¤„ç†
							jsonObjects.push(parsed);
						} catch (e) {
							// JSONè§£æé”™è¯¯æ—¶ï¼Œå°†åŸå§‹å­—ç¬¦ä¸²ä½œä¸ºæ— æ•ˆJSONä¼ é€’ç»™åç«¯
							jsonObjects.push({ _invalid: true, _originalLine: trimmedLine, _error: e.message });
						}
					}
					else {
						throw new Error(`ç¬¬${lineNumber}è¡Œæ ¼å¼æ— æ³•è¯†åˆ«: ${line.substring(0, 50)}${line.length > 50 ? '...' : ''}`);
					}
				}
			}

			// ç§»é™¤å‰ç«¯JSONå­—æ®µéªŒè¯ï¼Œäº¤ç»™åç«¯å¤„ç†

			// å¦‚æœåŒæ—¶æœ‰JSONå’Œé“¾æ¥ï¼Œä½¿ç”¨æ··åˆå¤„ç†
			if (jsonObjects.length > 0 && urlLines.length > 0) {
				return {
					action: 'addMixedProxy',
					collectionId: currentManagingCollection.id,
					data: {
						jsonProxies: jsonObjects,
						proxyUrls: urlLines.join('\n'),
						region
					}
				};
			}
			// å¦‚æœåªæœ‰JSONå¯¹è±¡
			else if (jsonObjects.length > 0) {
				return {
					action: 'addJSONProxy',
					collectionId: currentManagingCollection.id,
					proxies: jsonObjects,
					data: { region }
				};
			}
			// å¦‚æœåªæœ‰é“¾æ¥æ ¼å¼
			else if (urlLines.length > 0) {
				return {
					action: 'addProxy',
					data: {
						collectionId: currentManagingCollection.id,
						proxyUrls: urlLines.join('\n'),
						region
					}
				};
			}

			throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹ä¿¡æ¯');
		}



		// è®¾ç½®é›†åˆåœ°åŒºé€‰æ‹©å™¨
		function setupCollectionRegionSelector() {
			// ä¸ºé›†åˆåœ°åŒºé€‰æ‹©å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
			const collectionOptions = document.querySelectorAll('#collectionRegionOptions .select-option');
			collectionOptions.forEach(option => {
				option.addEventListener('click', function () {
					const value = this.getAttribute('data-value');
					const text = this.innerHTML;
					selectCollectionRegionOption(value, text);
				});
			});

			// ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
			document.addEventListener('click', function (event) {
				const collectionSelect = document.getElementById('collectionRegionSelect');
				if (collectionSelect && !collectionSelect.contains(event.target)) {
					document.getElementById('collectionRegionOptions').classList.remove('show');
					document.querySelector('#collectionRegionSelect .select-display').classList.remove('active');
				}
			});
		}

		// åŠ è½½è®¢é˜…é›†åˆåˆ—è¡¨
		async function loadSubCollections() {
			try {
				const response = await fetch('/api/sub-collections');
				subCollections = await response.json();
				renderSubCollections();
			} catch (error) {
				console.error('åŠ è½½è®¢é˜…é›†åˆå¤±è´¥:', error);
			}
		}

		// æ¸²æŸ“è®¢é˜…é›†åˆåˆ—è¡¨
		function renderSubCollections() {
			const listEl = document.getElementById('subCollectionList');

			if (subCollections.length === 0) {
				listEl.innerHTML = '<div class="empty-state"><div>ğŸ“‚</div><p>æš‚æ— è®¢é˜…é›†åˆï¼Œè¯·åˆ›å»ºæ–°é›†åˆ</p></div>';
				return;
			}

			let html = '';
			for (let i = 0; i < subCollections.length; i++) {
				const collection = subCollections[i];
				const subCount = collection.subscriptions.length;
				const origin = window.location.origin;
				const collectionUrl = `${origin}/clash/submerge/${collection.id}`;

				const enablePrefix = collection.enablePrefix !== false; // é»˜è®¤ä¸ºtrue
				const prefixStatus = enablePrefix ? 'å·²å¼€å¯' : 'å·²å…³é—­';
				const prefixClass = enablePrefix ? 'success' : '';

				html += '<div class="list-item" data-index="' + i + '">';
				html += '<div class="item-info">';
				html += '<div class="item-name">' + collection.name + '</div>';
				html += '<div class="item-details">è®¢é˜…æ•°é‡: ' + subCount + ' | å‰ç¼€åŠŸèƒ½: <span class="' + prefixClass + '">' + prefixStatus + '</span></div>';
				html += '<div class="item-details" style="font-size: 0.85em; margin-top: 4px;">è®¢é˜…é“¾æ¥: ' + collectionUrl + '</div>';
				html += '</div>';
				html += '<div class="item-actions">';
				html += '<div class="item-actions-row-1">';
				html += '<button class="btn clash-import" onclick="importSubCollectionToClash(\'' + collection.id + '\')">å¯¼å…¥Clash</button>';
				html += '<button class="btn" onclick="copySubCollectionLink(\'' + collection.id + '\')">å¤åˆ¶é“¾æ¥</button>';
				html += '<button class="btn" onclick="renameSubCollection(\'' + collection.id + '\')">é‡å‘½å</button>';
				html += '</div>';
				html += '<div class="item-actions-row-2">';
				html += '<button class="btn" onclick="manageSubCollection(\'' + collection.id + '\')">ç®¡ç†è®¢é˜…</button>';
				html += '<button class="btn ' + prefixClass + '" onclick="toggleSubCollectionPrefix(\'' + collection.id + '\')">' + (enablePrefix ? 'å…³é—­å‰ç¼€' : 'å¼€å¯å‰ç¼€') + '</button>';
				html += '<button class="btn danger" onclick="deleteSubCollection(\'' + collection.id + '\')">åˆ é™¤</button>';
				html += '</div>';
				html += '</div>';
				html += '</div>';
			}
			listEl.innerHTML = html;
		}

		// åˆ›å»ºæ–°çš„è®¢é˜…é›†åˆ
		async function createSubCollection() {
			const name = prompt('è¯·è¾“å…¥é›†åˆåç§°ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤åç§°ï¼‰:');
			if (name === null) return; // ç”¨æˆ·å–æ¶ˆ

			try {
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'create', data: { name } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('subCollectionMessage', result.error, 'error');
				} else {
					showMessage('subCollectionMessage', 'è®¢é˜…é›†åˆåˆ›å»ºæˆåŠŸ');
					loadSubCollections();
				}
			} catch (error) {
				showMessage('subCollectionMessage', 'åˆ›å»ºè®¢é˜…é›†åˆå¤±è´¥', 'error');
			}
		}

		// å¯¼å…¥åˆ°Clashï¼ˆè®¢é˜…é›†åˆï¼‰
		function importSubCollectionToClash(collectionId) {
			const origin = window.location.origin;
			const subscriptionUrl = `${origin}/clash/submerge/${collectionId}`;
			const clashScheme = generateClashScheme(subscriptionUrl);
			window.location.href = clashScheme;
		}

		// å¤åˆ¶é›†åˆè®¢é˜…é“¾æ¥
		function copySubCollectionLink(collectionId) {
			const origin = window.location.origin;
			const url = `${origin}/clash/submerge/${collectionId}`;
			copyToClipboard(url);
			showMessage('subCollectionMessage', 'è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
		}

		// é‡å‘½åè®¢é˜…é›†åˆ
		async function renameSubCollection(collectionId) {
			const collection = subCollections.find(c => c.id === collectionId);
			if (!collection) return;

			const newName = prompt('è¯·è¾“å…¥æ–°çš„é›†åˆåç§°:', collection.name);
			if (newName === null || newName.trim() === '') return;

			try {
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'rename', data: { id: collectionId, newName } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('subCollectionMessage', result.error, 'error');
				} else {
					showMessage('subCollectionMessage', 'é›†åˆé‡å‘½åæˆåŠŸ');
					loadSubCollections();
				}
			} catch (error) {
				showMessage('subCollectionMessage', 'é‡å‘½åé›†åˆå¤±è´¥', 'error');
			}
		}

		// åˆ é™¤è®¢é˜…é›†åˆ
		async function deleteSubCollection(collectionId) {
			const collection = subCollections.find(c => c.id === collectionId);
			if (!collection) return;

			if (!confirm(`ç¡®å®šè¦åˆ é™¤é›†åˆ "${collection.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;

			try {
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'delete', data: { id: collectionId } })
				});

				const result = await response.json();

				if (result.error) {
					showMessage('subCollectionMessage', result.error, 'error');
				} else {
					showMessage('subCollectionMessage', 'é›†åˆåˆ é™¤æˆåŠŸ');
					loadSubCollections();
				}
			} catch (error) {
				showMessage('subCollectionMessage', 'åˆ é™¤é›†åˆå¤±è´¥', 'error');
			}
		}


		// åˆ‡æ¢è®¢é˜…é›†åˆå‰ç¼€å¼€å…³
		async function toggleSubCollectionPrefix(collectionId) {
			try {
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						action: 'togglePrefix',
						collectionId: collectionId
					})
				});

				const result = await response.json();

				if (result.error) {
					showMessage('subCollectionMessage', result.error, 'error');
				} else {
					showMessage('subCollectionMessage', result.message);
					loadSubCollections();
				}
			} catch (error) {
				showMessage('subCollectionMessage', 'åˆ‡æ¢å‰ç¼€å¼€å…³å¤±è´¥', 'error');
			}
		}



		// ç®¡ç†é›†åˆä¸­çš„è®¢é˜…
		function manageSubCollection(collectionId) {
			const collection = subCollections.find(c => c.id === collectionId);
			if (!collection) return;

			currentManagingSubCollection = collection;

			// è®¾ç½®å¼¹çª—æ ‡é¢˜å’Œé“¾æ¥
			document.getElementById('subCollectionModalTitle').textContent = `ç®¡ç†è®¢é˜…é›†åˆ: ${collection.name}`;
			const origin = window.location.origin;
			const collectionUrl = `${origin}/clash/submerge/${collection.id}`;
			document.getElementById('currentSubCollectionLink').textContent = collectionUrl;

			// æ¸…ç©ºè¾“å…¥æ¡†
			document.getElementById('collectionSubUrl').value = '';
			document.getElementById('collectionSubMessage').style.display = 'none';

			// æ¸²æŸ“è®¢é˜…åˆ—è¡¨
			renderCollectionSubscriptions();

			// æ˜¾ç¤ºå¼¹çª—
			document.getElementById('subCollectionModal').style.display = 'block';
		}

		// å…³é—­è®¢é˜…é›†åˆç®¡ç†å¼¹çª—
		function closeSubCollectionModal() {
			document.getElementById('subCollectionModal').style.display = 'none';
			currentManagingSubCollection = null;
		}

		// è§£æè®¢é˜…åç§°ï¼Œæå–åŸºç¡€åç§°ã€æµé‡ä¿¡æ¯å’Œåˆ°æœŸæ—¶é—´
		function parseSubscriptionName(fullName) {
			const result = {
				name: fullName,
				traffic: null,
				expire: null,
				used: 0,
				total: 0,
				percentage: 0
			};

			// æå–æµé‡ä¿¡æ¯ [å·²ç”¨/æ€»é‡]
			const trafficMatch = fullName.match(/\[([^\]]+)\]/);
			if (trafficMatch) {
				result.traffic = trafficMatch[1];
				// å°è¯•è§£æå·²ç”¨/æ€»é‡
				const parts = trafficMatch[1].split('/');
				if (parts.length === 2) {
					result.used = parseTrafficValue(parts[0].trim());
					result.total = parseTrafficValue(parts[1].trim());
					if (result.total > 0) {
						result.percentage = Math.min(100, (result.used / result.total) * 100);
					}
				}
			}

			// æå–åˆ°æœŸæ—¶é—´ (YYYY-MM-DDåˆ°æœŸ)
			const expireMatch = fullName.match(/\(([^)]+åˆ°æœŸ)\)/);
			if (expireMatch) {
				result.expire = expireMatch[1];
			}

			// æå–åŸºç¡€åç§°ï¼ˆç§»é™¤æµé‡å’Œåˆ°æœŸä¿¡æ¯ï¼‰
			result.name = fullName
				.replace(/\s*\[.*?\]/g, '')
				.replace(/\s*\(.*?åˆ°æœŸ\)/g, '')
				.trim();

			return result;
		}

		// è§£ææµé‡å€¼ï¼ˆæ”¯æŒGBã€MBç­‰å•ä½ï¼‰
		function parseTrafficValue(str) {
			const match = str.match(/([\d.]+)\s*([KMGT]?B)/i);
			if (!match) return 0;

			const value = parseFloat(match[1]);
			const unit = match[2].toUpperCase();
			const multipliers = { 'B': 1, 'KB': 1024, 'MB': 1024 * 1024, 'GB': 1024 * 1024 * 1024, 'TB': 1024 * 1024 * 1024 * 1024 };
			return value * (multipliers[unit] || 1);
		}

		// æ¸²æŸ“é›†åˆä¸­çš„è®¢é˜…åˆ—è¡¨
		function renderCollectionSubscriptions() {
			if (!currentManagingSubCollection) return;

			const listEl = document.getElementById('collectionSubList');
			const subscriptions = currentManagingSubCollection.subscriptions;
			const subscriptionNames = currentManagingSubCollection.subscriptionNames;

			if (subscriptions.length === 0) {
				listEl.innerHTML = '<div class="empty-state"><div>ğŸ”—</div><p>æš‚æ— è®¢é˜…ï¼Œè¯·æ·»åŠ è®¢é˜…é“¾æ¥</p></div>';
				updateCollectionSubscriptionSelectionUI();
				return;
			}

			let html = '';
			let firstNewlyAddedIndex = -1;

			for (let i = 0; i < subscriptions.length; i++) {
				const sub = subscriptions[i];
				const fullName = subscriptionNames[i] || ('è®¢é˜…' + (i + 1));
				const parsed = parseSubscriptionName(fullName);
				const isNewlyAdded = newlyAddedCollectionSubscriptions.has(fullName);
				const highlightClass = isNewlyAdded ? ' newly-added' : '';

				// è®°å½•ç¬¬ä¸€ä¸ªæ–°æ·»åŠ è®¢é˜…çš„ä½ç½®
				if (isNewlyAdded && firstNewlyAddedIndex === -1) {
					firstNewlyAddedIndex = i;
				}

				html += '<div class="list-item subscription-item' + highlightClass + '" data-index="' + i + '">';
				// æ¡Œé¢ç«¯å¤é€‰æ¡†
				html += '<input type="checkbox" class="collection-subscription-checkbox desktop-checkbox" data-index="' + i + '" onchange="syncCheckboxState(' + i + ', \'subscription\')">';
				// ç§»åŠ¨ç«¯å¤é€‰æ¡†å®¹å™¨
				html += '<div class="checkbox-wrapper">';
				html += '<input type="checkbox" class="collection-subscription-checkbox mobile-checkbox" data-index="' + i + '" onchange="syncCheckboxState(' + i + ', \'subscription\')">';
				html += '</div>';
				html += '<div class="item-info">';
				html += '<div class="item-name" id="collectionSubName-' + i + '">';
				html += '<span class="name-text">' + parsed.name + '</span>';
				html += '</div>';
				html += '<div class="item-details">' + sub + '</div>';

				// æµé‡å’Œåˆ°æœŸä¿¡æ¯åŒºåŸŸ
				if (parsed.traffic || parsed.expire) {
					html += '<div class="subscription-meta">';

					// æµé‡ä¿¡æ¯
					if (parsed.traffic) {
						html += '<div class="traffic-info">';
						html += '<span class="traffic-label">ğŸ“Š æµé‡:</span>';
						html += '<span class="traffic-value">' + parsed.traffic + '</span>';
						html += '</div>';
					}

					// åˆ°æœŸæ—¶é—´
					if (parsed.expire) {
						html += '<div class="expire-info">';
						html += '<span class="expire-label">â°</span>';
						html += '<span class="expire-value">' + parsed.expire + '</span>';
						html += '</div>';
					}

					html += '</div>';
				}

				html += '</div>';
				html += '<div class="item-actions">';
				html += '<button class="btn" onclick="editCollectionSubscriptionName(' + i + ')">ç¼–è¾‘åç§°</button>';
				html += '<button class="btn danger" onclick="deleteSingleCollectionSubscription(' + i + ')">åˆ é™¤</button>';
				html += '</div>';
				html += '</div>';
			}
			listEl.innerHTML = html;
			updateCollectionSubscriptionSelectionUI();

			// è‡ªåŠ¨æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªæ–°æ·»åŠ çš„è®¢é˜…
			if (firstNewlyAddedIndex !== -1) {
				setTimeout(() => {
					const listItems = listEl.querySelectorAll('.list-item');
					if (listItems[firstNewlyAddedIndex]) {
						listItems[firstNewlyAddedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
					}
				}, 100);
			}

			// 15ç§’åç§»é™¤é«˜äº®æ•ˆæœ
			setTimeout(() => {
				newlyAddedCollectionSubscriptions.clear();
				document.querySelectorAll('#collectionSubList .list-item.newly-added').forEach(item => {
					item.classList.remove('newly-added');
				});
			}, 15000);
		}

		// ========== é›†åˆè®¢é˜…é€‰æ‹©åŠŸèƒ½ ==========

		// æ›´æ–°é›†åˆè®¢é˜…é€‰æ‹©UIçŠ¶æ€
		function updateCollectionSubscriptionSelectionUI() {
			// åŒæ­¥æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å¤é€‰æ¡†çŠ¶æ€
			document.querySelectorAll('#collectionSubList .list-item').forEach((item, index) => {
				const desktopCheckbox = item.querySelector('.collection-subscription-checkbox:not(.mobile-checkbox)');
				const mobileCheckbox = item.querySelector('.collection-subscription-checkbox.mobile-checkbox');

				if (desktopCheckbox && mobileCheckbox) {
					// å¦‚æœå…¶ä¸­ä¸€ä¸ªè¢«é€‰ä¸­ï¼ŒåŒæ­¥åˆ°å¦ä¸€ä¸ª
					if (desktopCheckbox.checked !== mobileCheckbox.checked) {
						mobileCheckbox.checked = desktopCheckbox.checked;
					}
				}
			});

			const checkboxes = document.querySelectorAll('.collection-subscription-checkbox:not(.mobile-checkbox)');
			const selectedCheckboxes = document.querySelectorAll('.collection-subscription-checkbox:not(.mobile-checkbox):checked');
			const selectedCount = selectedCheckboxes.length;
			const totalCount = checkboxes.length;

			// æ›´æ–°é€‰æ‹©ä¿¡æ¯æ˜¾ç¤º
			const selectionInfo = document.getElementById('collectionSubscriptionSelectionInfo');
			const selectAllBtn = document.getElementById('selectAllCollectionSubscriptionsBtn');
			const copyBtn = document.getElementById('copySelectedCollectionSubscriptionsBtn');
			const deleteBtn = document.getElementById('deleteSelectedCollectionSubscriptionsBtn');

			if (selectedCount > 0) {
				selectionInfo.style.display = 'block';
				selectionInfo.textContent = `å·²é€‰æ‹© ${selectedCount} / ${totalCount} ä¸ªè®¢é˜…`;
				copyBtn.disabled = false;
				deleteBtn.disabled = false;
			} else {
				selectionInfo.style.display = 'none';
				copyBtn.disabled = true;
				deleteBtn.disabled = true;
			}

			// æ›´æ–°å…¨é€‰æŒ‰é’®æ–‡æœ¬
			if (selectedCount === totalCount && totalCount > 0) {
				selectAllBtn.textContent = 'å–æ¶ˆå…¨é€‰';
			} else {
				selectAllBtn.textContent = 'å…¨é€‰';
			}

			// æ›´æ–°åˆ—è¡¨é¡¹çš„é€‰ä¸­æ ·å¼
			document.querySelectorAll('#collectionSubList .list-item').forEach((item, index) => {
				const checkbox = item.querySelector('.collection-subscription-checkbox:not(.mobile-checkbox)');
				if (checkbox && checkbox.checked) {
					item.classList.add('selected');
				} else {
					item.classList.remove('selected');
				}
			});
		}

		// å…¨é€‰/å–æ¶ˆå…¨é€‰é›†åˆè®¢é˜…
		function selectAllCollectionSubscriptions() {
			const checkboxes = document.querySelectorAll('.collection-subscription-checkbox:not(.mobile-checkbox)');
			const allChecked = Array.from(checkboxes).every(cb => cb.checked);

			// åŒæ—¶æ›´æ–°æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å¤é€‰æ¡†
			document.querySelectorAll('.collection-subscription-checkbox').forEach(cb => {
				cb.checked = !allChecked;
			});

			updateCollectionSubscriptionSelectionUI();
		}

		// è·å–é€‰ä¸­çš„é›†åˆè®¢é˜…ç´¢å¼•
		function getSelectedCollectionSubscriptionIndexes() {
			const selectedCheckboxes = document.querySelectorAll('.collection-subscription-checkbox:not(.mobile-checkbox):checked');
			return Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
		}

		// å¤åˆ¶é€‰ä¸­é›†åˆè®¢é˜…çš„é“¾æ¥
		function copySelectedCollectionSubscriptions() {
			const selectedIndexes = getSelectedCollectionSubscriptionIndexes();
			if (selectedIndexes.length === 0) {
				showCollectionSubMessage('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„è®¢é˜…', 'warning');
				return;
			}

			const selectedUrls = selectedIndexes.map(index => currentManagingSubCollection.subscriptions[index]);
			const urlsText = selectedUrls.join('\n');

			navigator.clipboard.writeText(urlsText).then(() => {
				showCollectionSubMessage(`å·²å¤åˆ¶ ${selectedIndexes.length} ä¸ªè®¢é˜…é“¾æ¥`, 'success');
			}).catch(() => {
				// é™çº§æ–¹æ¡ˆ
				const textArea = document.createElement('textarea');
				textArea.value = urlsText;
				document.body.appendChild(textArea);
				textArea.select();
				document.execCommand('copy');
				document.body.removeChild(textArea);
				showCollectionSubMessage(`å·²å¤åˆ¶ ${selectedIndexes.length} ä¸ªè®¢é˜…é“¾æ¥`, 'success');
			});
		}

		// åˆ é™¤é€‰ä¸­çš„é›†åˆè®¢é˜…
		async function deleteSelectedCollectionSubscriptions() {
			const selectedIndexes = getSelectedCollectionSubscriptionIndexes();
			if (selectedIndexes.length === 0) {
				showCollectionSubMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®¢é˜…', 'warning');
				return;
			}

			showConfirmModal(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIndexes.length} ä¸ªè®¢é˜…å—ï¼Ÿ`, async function () {
				try {
					const response = await fetch('/api/sub-collections', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							action: 'batchDeleteSubscription',
							collectionId: currentManagingSubCollection.id,
							indexes: selectedIndexes
						})
					});

					const result = await response.json();
					if (result.success) {
						showCollectionSubMessage(`æˆåŠŸåˆ é™¤ ${selectedIndexes.length} ä¸ªè®¢é˜…`, 'success');

						// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
						await loadSubCollections();
						currentManagingSubCollection = subCollections.find(c => c.id === currentManagingSubCollection.id);
						renderCollectionSubscriptions();
					} else {
						showCollectionSubMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
					}
				} catch (error) {
					showCollectionSubMessage('åˆ é™¤è®¢é˜…å¤±è´¥', 'error');
				}
			});
		}

		// å¤åˆ¶å½“å‰è®¢é˜…é›†åˆé“¾æ¥
		function copyCurrentSubCollectionLink() {
			if (!currentManagingSubCollection) return;
			const origin = window.location.origin;
			const url = `${origin}/clash/submerge/${currentManagingSubCollection.id}`;
			copyToClipboard(url);
			showCollectionSubMessage('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
		}

		// æ˜¾ç¤ºè®¢é˜…é›†åˆç®¡ç†æ¶ˆæ¯
		function showCollectionSubMessage(message, type = 'success') {
			const messageEl = document.getElementById('collectionSubMessage');
			messageEl.textContent = message;
			messageEl.className = 'message ' + type;
			messageEl.style.display = 'block';

			let displayTime;
			if (type === 'error') {
				displayTime = 8000;
			} else if (message.includes('æ´»è·ƒæ£€æµ‹å®Œæˆ') && message.includes('ç§»é™¤çš„è®¢é˜…')) {
				displayTime = 15000;
			} else if (message.includes('æ´»è·ƒæ£€æµ‹å®Œæˆ')) {
				displayTime = 8000;
			} else {
				displayTime = 3000;
			}

			setTimeout(() => {
				messageEl.style.display = 'none';
			}, displayTime);
		}

		// å‘å½“å‰é›†åˆæ·»åŠ è®¢é˜…
		async function addSubscriptionToCurrentCollection() {
			if (!currentManagingSubCollection) return;

			const subscriptionUrls = document.getElementById('collectionSubUrl').value.trim();
			if (!subscriptionUrls) {
				showCollectionSubMessage('è¯·è¾“å…¥è®¢é˜…é“¾æ¥', 'error');
				return;
			}

			// è®¡ç®—è®¢é˜…æ•°é‡
			const urls = subscriptionUrls.split('\n').map(url => url.trim()).filter(url => url);
			const totalUrls = urls.length;

			// æ¸…ç©ºæ“ä½œæ—¥å¿—å¹¶æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
			clearCollectionSubOutput();
			addCollectionSubOutput(`å¼€å§‹æ·»åŠ  ${totalUrls} ä¸ªè®¢é˜…åˆ°é›†åˆ: ${currentManagingSubCollection.name}`);

			try {
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						action: 'addSubscription',
						data: {
							collectionId: currentManagingSubCollection.id,
							subscriptionUrls: subscriptionUrls
						}
					})
				});

				addCollectionSubOutput('å¤„ç†å®Œæˆï¼Œåˆ†æç»“æœ...');
				const result = await response.json();

				if (result.error) {
					addCollectionSubOutput(`æ·»åŠ å¤±è´¥: ${result.error}`, 'error');
					showCollectionSubMessage(result.error, 'error');
				} else {
					let message = `æˆåŠŸæ·»åŠ  ${result.successCount} ä¸ªè®¢é˜…`;

					// æ·»åŠ æˆåŠŸæ—¥å¿—
					addCollectionSubOutput(`âœ“ æˆåŠŸæ·»åŠ : ${result.successCount} ä¸ªè®¢é˜…`, 'success');

					if (result.duplicateCount > 0) {
						message += `ï¼Œè·³è¿‡ ${result.duplicateCount} ä¸ªé‡å¤è®¢é˜…`;
						addCollectionSubOutput(`âš  é‡å¤è·³è¿‡: ${result.duplicateCount} ä¸ªè®¢é˜…`, 'warning');
					}
					if (result.failedCount > 0) {
						message += `ï¼Œ${result.failedCount} ä¸ªè®¢é˜…æ·»åŠ å¤±è´¥`;
						addCollectionSubOutput(`âœ— æ·»åŠ å¤±è´¥: ${result.failedCount} ä¸ªè®¢é˜…`, 'error');

						// æ˜¾ç¤ºå¤±è´¥è®¢é˜…çš„è¯¦ç»†ä¿¡æ¯
						if (result.failedSubscriptions && result.failedSubscriptions.length > 0) {
							result.failedSubscriptions.forEach((failed, index) => {
								addCollectionSubOutput(`  ${index + 1}. ${failed.error}`, 'error');
								addCollectionSubOutput(`     URL: ${failed.url}`, 'error');
							});
						}
					}

					showCollectionSubMessage(message, result.failedCount > 0 ? 'info' : 'success');

					// æ¸…ç©ºè¾“å…¥æ¡†
					document.getElementById('collectionSubUrl').value = '';

					// æ ‡è®°æ–°æ·»åŠ çš„è®¢é˜…ç”¨äºé«˜äº®æ˜¾ç¤º
					if (result.addedSubscriptions && result.addedSubscriptions.length > 0) {
						result.addedSubscriptions.forEach(sub => {
							newlyAddedCollectionSubscriptions.add(sub.name);
						});
					}

					// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
					await loadSubCollections();
					currentManagingSubCollection = subCollections.find(c => c.id === currentManagingSubCollection.id);
					renderCollectionSubscriptions();
				}
			} catch (error) {
				addCollectionSubOutput(`æ·»åŠ è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
				showCollectionSubMessage('æ·»åŠ è®¢é˜…å¤±è´¥: ' + error.message, 'error');
			}
		}

		// ç¼–è¾‘é›†åˆä¸­è®¢é˜…çš„åç§°
		function editCollectionSubscriptionName(index) {
			if (!currentManagingSubCollection) return;

			const nameElement = document.getElementById('collectionSubName-' + index);
			const currentName = currentManagingSubCollection.subscriptionNames[index] || ('è®¢é˜…' + (index + 1));

			// åˆ›å»ºè¾“å…¥æ¡†
			const input = document.createElement('input');
			input.type = 'text';
			input.value = currentName;
			input.className = 'edit-name-input';
			input.style.cssText = `
				width: 100%;
				padding: 4px 8px;
				border: 1px solid #6B8E9F;
				border-radius: 4px;
				font-size: 14px;
				background: #FFFFFF;
			`;

			// ä¿å­˜åŸå§‹å†…å®¹
			const originalContent = nameElement.innerHTML;

			// æ›¿æ¢ä¸ºè¾“å…¥æ¡†
			nameElement.innerHTML = '';
			nameElement.appendChild(input);
			input.focus();
			input.select();

			// å¤„ç†ä¿å­˜
			async function saveName() {
				const newName = input.value.trim();
				if (newName === '' || newName === currentName) {
					// å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹å†…å®¹
					nameElement.innerHTML = originalContent;
					return;
				}

				try {
					const response = await fetch('/api/sub-collections', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							action: 'updateSubscriptionName',
							data: {
								collectionId: currentManagingSubCollection.id,
								index,
								newName
							}
						})
					});

					const result = await response.json();

					if (result.error) {
						showCollectionSubMessage(result.error, 'error');
						nameElement.innerHTML = originalContent;
					} else {
						showCollectionSubMessage('è®¢é˜…åç§°æ›´æ–°æˆåŠŸ');
						// æ›´æ–°æœ¬åœ°æ•°æ®
						currentManagingSubCollection.subscriptionNames[index] = newName;
						nameElement.innerHTML = newName;
					}
				} catch (error) {
					showCollectionSubMessage('æ›´æ–°è®¢é˜…åç§°å¤±è´¥', 'error');
					nameElement.innerHTML = originalContent;
				}
			}

			// å¤„ç†å–æ¶ˆ
			function cancelEdit() {
				nameElement.innerHTML = originalContent;
			}

			// ç»‘å®šäº‹ä»¶
			input.addEventListener('blur', saveName);
			input.addEventListener('keydown', function (e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					saveName();
				} else if (e.key === 'Escape') {
					e.preventDefault();
					cancelEdit();
				}
			});
		}

		// å½“å‰é›†åˆçš„æ´»è·ƒæ£€æµ‹
		async function activeDetectionForCurrentCollection() {
			if (!currentManagingSubCollection) return;

			const subscriptions = currentManagingSubCollection.subscriptions;
			if (subscriptions.length === 0) {
				showCollectionSubMessage('æ²¡æœ‰è®¢é˜…å¯ä»¥æ£€æµ‹', 'error');
				return;
			}

			const btn = document.getElementById('currentCollectionActiveDetectionBtn');

			// ç¦ç”¨æŒ‰é’®å¹¶æ¸…ç©ºæ“ä½œæ—¥å¿—
			btn.disabled = true;
			btn.textContent = 'æ£€æµ‹ä¸­...';
			document.getElementById('collectionSubMessage').style.display = 'none';
			clearCollectionSubOutput();
			addCollectionSubOutput(`å¼€å§‹æ´»è·ƒæ£€æµ‹é›†åˆ: ${currentManagingSubCollection.name}ï¼Œå…± ${subscriptions.length} ä¸ªè®¢é˜…`);

			try {
				// å‡†å¤‡æ£€æµ‹æ•°æ®
				const results = subscriptions.map((url, index) => ({
					url: url,
					name: currentManagingSubCollection.subscriptionNames[index] || `è®¢é˜…${index + 1}`,
					index: index
				}));

				// å‘é€æ‰¹é‡æ£€æµ‹è¯·æ±‚
				const response = await fetch('/api/sub-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						action: 'activeDetection',
						data: {
							collectionId: currentManagingSubCollection.id,
							results: results
						}
					})
				});

				addCollectionSubOutput('æ£€æµ‹å®Œæˆï¼Œæ­£åœ¨å¤„ç†ç»“æœ...');
				const result = await response.json();

				if (result.error) {
					addCollectionSubOutput(`æ£€æµ‹å¤±è´¥: ${result.error}`, 'error');
					showCollectionSubMessage(result.error, 'error');
				} else {
					// å¤„ç†æ£€æµ‹ç»“æœ
					const removedSubscriptions = result.removedSubscriptions || [];
					const totalChecked = result.totalChecked || 0;
					const totalRemoved = removedSubscriptions.length;

					let message = `æ´»è·ƒæ£€æµ‹å®Œæˆï¼æ£€æµ‹äº† ${totalChecked} ä¸ªè®¢é˜…`;

					// æ·»åŠ æ£€æµ‹å®Œæˆæ—¥å¿—
					addCollectionSubOutput(`âœ“ æ£€æµ‹å®Œæˆ: ${totalChecked} ä¸ªè®¢é˜…`, 'success');

					if (totalRemoved > 0) {
						message += `ï¼Œç§»é™¤äº† ${totalRemoved} ä¸ªæ— æ•ˆè®¢é˜…`;
						addCollectionSubOutput(`âœ— ç§»é™¤æ— æ•ˆ: ${totalRemoved} ä¸ªè®¢é˜…`, 'error');

						// æ˜¾ç¤ºç§»é™¤çš„è®¢é˜…è¯¦æƒ…
						const removedDetails = removedSubscriptions.map(sub =>
							`â€¢ ${sub.name}: ${sub.reason}`
						).join('\n');

						message += `\n\nç§»é™¤çš„è®¢é˜…:\n${removedDetails}`;

						// æ·»åŠ ç§»é™¤è¯¦æƒ…åˆ°æ—¥å¿—
						removedSubscriptions.forEach((sub, index) => {
							addCollectionSubOutput(`  ${index + 1}. ${sub.name}`, 'error');
							addCollectionSubOutput(`     åŸå› : ${sub.reason}`, 'error');
						});
					} else {
						message += 'ï¼Œæ‰€æœ‰è®¢é˜…éƒ½æ˜¯æœ‰æ•ˆçš„';
						addCollectionSubOutput('âœ“ æ‰€æœ‰è®¢é˜…éƒ½æœ‰æ•ˆ', 'success');
					}

					showCollectionSubMessage(message, totalRemoved > 0 ? 'info' : 'success');

					// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
					await loadSubCollections();
					currentManagingSubCollection = subCollections.find(c => c.id === currentManagingSubCollection.id);
					renderCollectionSubscriptions();
				}
			} catch (error) {
				addCollectionSubOutput(`æ´»è·ƒæ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
				showCollectionSubMessage('æ´»è·ƒæ£€æµ‹å¤±è´¥: ' + error.message, 'error');
			} finally {
				// æ¢å¤æŒ‰é’®çŠ¶æ€
				btn.disabled = false;
				btn.textContent = 'æ´»è·ƒæ£€æµ‹';
			}
		}

		// å¤åˆ¶é“¾æ¥
		function copyLink(elementId) {
			const linkElement = document.getElementById(elementId);
			const text = linkElement.textContent;

			navigator.clipboard.writeText(text).then(() => {
				// ç®€å•çš„è§†è§‰åé¦ˆ
				const originalText = linkElement.textContent;
				linkElement.textContent = 'å·²å¤åˆ¶!';
				linkElement.style.color = '#9CAE9A';

				setTimeout(() => {
					linkElement.textContent = originalText;
					linkElement.style.color = '';
				}, 1000);
			}).catch(() => {
				// é™çº§æ–¹æ¡ˆ
				const textArea = document.createElement('textarea');
				textArea.value = text;
				document.body.appendChild(textArea);
				textArea.select();
				document.execCommand('copy');
				document.body.removeChild(textArea);

				const originalText = linkElement.textContent;
				linkElement.textContent = 'å·²å¤åˆ¶!';
				linkElement.style.color = '#9CAE9A';

				setTimeout(() => {
					linkElement.textContent = originalText;
					linkElement.style.color = '';
				}, 1000);
			});
		}

		// æ˜¾ç¤ºé›†åˆæ“ä½œè¾“å‡º
		function showCollectionOperationOutput(message, append = false) {
			const outputContainer = document.getElementById('collectionOperationOutput');
			const outputContent = document.getElementById('collectionOutputContent');

			if (!outputContainer || !outputContent) {
				console.error('é›†åˆæ“ä½œè¾“å‡ºæ¡†å…ƒç´ æœªæ‰¾åˆ°');
				return;
			}

			outputContainer.style.display = 'block';

			if (append) {
				outputContent.textContent += '\n' + message;
			} else {
				outputContent.textContent = message;
			}

			// æ»šåŠ¨åˆ°åº•éƒ¨
			outputContent.scrollTop = outputContent.scrollHeight;
		}

		// æ¸…ç©ºé›†åˆæ“ä½œè¾“å‡º
		function clearCollectionOperationOutput() {
			const outputContainer = document.getElementById('collectionOperationOutput');
			const outputContent = document.getElementById('collectionOutputContent');

			if (outputContainer) {
				outputContainer.style.display = 'none';
			}
			if (outputContent) {
				outputContent.textContent = '';
			}
		}

		// æ·»åŠ è®¢é˜…é›†åˆè¾“å‡ºæ—¥å¿—
		function addCollectionSubOutput(message, type = 'info') {
			const outputBox = document.getElementById('collectionSubOutputBox');
			const placeholder = outputBox.querySelector('.output-placeholder');

			if (placeholder) {
				placeholder.remove();
			}

			const timestamp = new Date().toLocaleTimeString();
			const entry = document.createElement('div');
			entry.className = `output-entry ${type}`;
			entry.innerHTML = `
				<span class="output-time">[${timestamp}]</span>
				<span class="output-message">${message}</span>
			`;

			outputBox.appendChild(entry);
			outputBox.scrollTop = outputBox.scrollHeight;
		}

		// æ¸…ç©ºè®¢é˜…é›†åˆè¾“å‡ºæ—¥å¿—
		function clearCollectionSubOutput() {
			const outputBox = document.getElementById('collectionSubOutputBox');
			outputBox.innerHTML = '<div class="output-placeholder">æš‚æ— æ“ä½œè®°å½•</div>';
		}

		// ========== ç¡®è®¤åˆ é™¤å¼¹çª—åŠŸèƒ½ ==========

		let confirmCallback = null;

		// æ˜¾ç¤ºç¡®è®¤åˆ é™¤å¼¹çª—
		function showConfirmModal(message, callback) {
			document.getElementById('confirmMessage').textContent = message;
			document.getElementById('confirmModal').style.display = 'block';
			confirmCallback = callback;
		}

		// éšè—ç¡®è®¤åˆ é™¤å¼¹çª—
		function hideConfirmModal() {
			document.getElementById('confirmModal').style.display = 'none';
			confirmCallback = null;
		}

		// ç¡®è®¤åˆ é™¤
		function confirmDelete() {
			if (confirmCallback) {
				confirmCallback();
			}
			hideConfirmModal();
		}

		// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
		document.getElementById('confirmModal').addEventListener('click', function (event) {
			if (event.target === this) {
				hideConfirmModal();
			}
		});

		// ESCé”®å…³é—­å¼¹çª—
		document.addEventListener('keydown', function (event) {
			if (event.key === 'Escape' && document.getElementById('confirmModal').style.display === 'block') {
				hideConfirmModal();
			}
		});

		// åŒæ­¥æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å¤é€‰æ¡†çŠ¶æ€
		function syncCheckboxState(index, type) {
			let desktopCheckbox, mobileCheckbox;

			if (type === 'proxy') {
				desktopCheckbox = document.querySelector(`#collectionProxyList .list-item[data-index="${index}"] .desktop-checkbox`);
				mobileCheckbox = document.querySelector(`#collectionProxyList .list-item[data-index="${index}"] .mobile-checkbox`);
			} else if (type === 'subscription') {
				desktopCheckbox = document.querySelector(`#collectionSubList .list-item[data-index="${index}"] .desktop-checkbox`);
				mobileCheckbox = document.querySelector(`#collectionSubList .list-item[data-index="${index}"] .mobile-checkbox`);
			}

			if (desktopCheckbox && mobileCheckbox) {
				// åŒæ­¥ä¸¤ä¸ªå¤é€‰æ¡†çš„çŠ¶æ€
				if (event.target.classList.contains('desktop-checkbox')) {
					mobileCheckbox.checked = desktopCheckbox.checked;
				} else {
					desktopCheckbox.checked = mobileCheckbox.checked;
				}
			}

			// æ›´æ–°UI
			if (type === 'proxy') {
				updateCollectionProxySelectionUI();
			} else if (type === 'subscription') {
				updateCollectionSubscriptionSelectionUI();
			}
		}

		// åˆ é™¤å•ä¸ªé›†åˆèŠ‚ç‚¹
		async function deleteSingleCollectionProxy(index) {
			if (!currentManagingCollection) return;

			const proxy = currentManagingCollection.proxies[index];
			if (!proxy) return;

			showConfirmModal(`ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${proxy.name}" å—ï¼Ÿ`, async function () {
				try {
					const response = await fetch('/api/proxy-collections', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							action: 'deleteProxy',
							data: {
								collectionId: currentManagingCollection.id,
								index: index
							}
						})
					});

					const result = await response.json();
					if (result.success) {
						showCollectionMessage(`å·²åˆ é™¤èŠ‚ç‚¹: ${proxy.name}`, 'success');
						addCollectionOutput(`âœ— åˆ é™¤èŠ‚ç‚¹: ${proxy.name}`, 'warning');

						// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
						await loadProxyCollections();
						currentManagingCollection = proxyCollections.find(c => c.id === currentManagingCollection.id);
						renderCollectionProxies();
					} else {
						showCollectionMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
					}
				} catch (error) {
					showCollectionMessage('åˆ é™¤èŠ‚ç‚¹å¤±è´¥', 'error');
				}
			});
		}

		// é‡å‘½åé›†åˆèŠ‚ç‚¹
		async function renameCollectionProxy(index) {
			if (!currentManagingCollection) return;

			const proxy = currentManagingCollection.proxies[index];
			if (!proxy) return;

			const newName = prompt('è¯·è¾“å…¥æ–°çš„èŠ‚ç‚¹åç§°:', proxy.name);
			if (!newName || newName === proxy.name) return;

			try {
				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						action: 'updateProxyName',
						data: {
							collectionId: currentManagingCollection.id,
							index: index,
							newName: newName
						}
					})
				});

				const result = await response.json();
				if (result.success) {
					showCollectionMessage(`èŠ‚ç‚¹å·²é‡å‘½å: ${proxy.name} â†’ ${newName}`, 'success');
					addCollectionOutput(`âœ“ é‡å‘½åèŠ‚ç‚¹: ${proxy.name} â†’ ${newName}`, 'success');

					// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
					await loadProxyCollections();
					currentManagingCollection = proxyCollections.find(c => c.id === currentManagingCollection.id);
					renderCollectionProxies();
				} else {
					showCollectionMessage(result.error || 'é‡å‘½åå¤±è´¥', 'error');
				}
			} catch (error) {
				showCollectionMessage('é‡å‘½åèŠ‚ç‚¹å¤±è´¥', 'error');
			}
		}

		// ä¿®æ”¹é›†åˆèŠ‚ç‚¹IP
		async function changeProxyServer(index) {
			if (!currentManagingCollection) return;

			const proxy = currentManagingCollection.proxies[index];
			if (!proxy) return;

			const newServer = prompt('è¯·è¾“å…¥æ–°çš„æœåŠ¡å™¨åœ°å€ (IPæˆ–åŸŸå):', proxy.server);
			if (!newServer || newServer === proxy.server) return;

			try {
				const response = await fetch('/api/proxy-collections', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						action: 'updateProxyServer',
						data: {
							collectionId: currentManagingCollection.id,
							index: index,
							newServer: newServer
						}
					})
				});

				const result = await response.json();
				if (result.success) {
					showCollectionMessage(`èŠ‚ç‚¹æœåŠ¡å™¨å·²æ›´æ–°: ${proxy.server} â†’ ${newServer}`, 'success');
					addCollectionOutput(`âœ“ æ›´æ–°æœåŠ¡å™¨: ${proxy.name} (${proxy.server} â†’ ${newServer})`, 'success');

					// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
					await loadProxyCollections();
					currentManagingCollection = proxyCollections.find(c => c.id === currentManagingCollection.id);
					renderCollectionProxies();
				} else {
					showCollectionMessage(result.error || 'æ›´æ–°æœåŠ¡å™¨å¤±è´¥', 'error');
				}
			} catch (error) {
				showCollectionMessage('æ›´æ–°æœåŠ¡å™¨å¤±è´¥', 'error');
			}
		}

		// åˆ é™¤å•ä¸ªé›†åˆè®¢é˜…
		async function deleteSingleCollectionSubscription(index) {
			if (!currentManagingSubCollection) return;

			const subscription = currentManagingSubCollection.subscriptions[index];
			const subName = currentManagingSubCollection.subscriptionNames[index] || `è®¢é˜…${index + 1}`;
			if (!subscription) return;

			showConfirmModal(`ç¡®å®šè¦åˆ é™¤è®¢é˜… "${subName}" å—ï¼Ÿ`, async function () {
				try {
					const response = await fetch('/api/sub-collections', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							action: 'deleteSubscription',
							data: {
								collectionId: currentManagingSubCollection.id,
								index: index
							}
						})
					});

					const result = await response.json();
					if (result.success) {
						showCollectionSubMessage(`å·²åˆ é™¤è®¢é˜…: ${subName}`, 'success');
						addCollectionSubOutput(`âœ— åˆ é™¤è®¢é˜…: ${subName}`, 'warning');

						// é‡æ–°åŠ è½½é›†åˆæ•°æ®å¹¶æ¸²æŸ“
						await loadSubCollections();
						currentManagingSubCollection = subCollections.find(c => c.id === currentManagingSubCollection.id);
						renderCollectionSubscriptions();
					} else {
						showCollectionSubMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
					}
				} catch (error) {
					showCollectionSubMessage('åˆ é™¤è®¢é˜…å¤±è´¥', 'error');
				}
			});
		}


	</script>

	<!-- ç¡®è®¤åˆ é™¤å¼¹çª— -->
	<div id="confirmModal" class="confirm-modal">
		<div class="confirm-modal-content">
			<div class="confirm-modal-header">
				<h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
			</div>
			<div class="confirm-modal-body">
				<p id="confirmMessage">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é¡¹ç›®å—ï¼Ÿ</p>
				<div class="confirm-modal-actions">
					<button class="confirm-btn secondary" onclick="hideConfirmModal()">å–æ¶ˆ</button>
					<button class="confirm-btn danger" id="confirmDeleteBtn" onclick="confirmDelete()">åˆ é™¤</button>
				</div>
			</div>
		</div>
	</div>
</body>

</html>